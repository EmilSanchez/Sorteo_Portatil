<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bendiciones Universitaria - Sistema Completo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce { animation: bounce 1s infinite; }
        body {
            background: linear-gradient(135deg, #2a0168 0%, #182f6e 50%, #222058 100%);
            min-height: 100vh;
        }
        .ticket-card { transition: all 0.3s ease; }
        .ticket-card:hover:not(:disabled) { transform: scale(1.05); }
    </style>
</head>
<body class="text-white">
    
    <!-- Header -->
    <div class="bg-black/30 backdrop-blur-md shadow-xl">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="text-center">
                <h1 class="text-4xl font-bold mb-2">Bendiciones con el fin de reunir Fondos Universitarios</h1>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto items-start">
                    <div class="col-span-1 md:col-span-3">
                        <div id="carousel" class="relative bg-white/5 border border-white/20 rounded-lg overflow-hidden w-full h-48 md:h-64">
                            <div class="relative w-full h-full">
                                <img src="" alt="Imagen 1" class="absolute inset-0 w-full h-full object-cover transition-opacity duration-700 opacity-0" data-slide="0">
                                <img src="" alt="Imagen 2" class="absolute inset-0 w-full h-full object-cover transition-opacity duration-700 opacity-0" data-slide="1">
                                <img src="" alt="Imagen 3" class="absolute inset-0 w-full h-full object-cover transition-opacity duration-700 opacity-0" data-slide="2">
                            </div>

                            <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2 z-10" id="carouselDots" aria-hidden="false">
                                <button class="w-3 h-3 rounded-full bg-white/40" data-dot="0"></button>
                                <button class="w-3 h-3 rounded-full bg-white/20" data-dot="1"></button>
                                <button class="w-3 h-3 rounded-full bg-white/20" data-dot="2"></button>
                            </div>
                        </div>

                        <script>
                            (function () {
                                const carousel = document.getElementById('carousel');
                                const slides = Array.from(carousel.querySelectorAll('img[data-slide]'));
                                const dots = Array.from(document.querySelectorAll('#carouselDots [data-dot]'));
                                let current = 0;
                                let interval = null;
                                const show = (i) => {
                                    slides.forEach((s, idx) => {
                                        s.classList.toggle('opacity-100', idx === i);
                                        s.classList.toggle('opacity-0', idx !== i);
                                    });
                                    dots.forEach((d, idx) => {
                                        d.classList.toggle('bg-white/80', idx === i);
                                        d.classList.toggle('bg-white/20', idx !== i);
                                    });
                                    current = i;
                                };
                                const next = () => show((current + 1) % slides.length);

                                // Init
                                show(0);
                                interval = setInterval(next, 2000);

                                // Pause on hover
                                carousel.addEventListener('mouseenter', () => clearInterval(interval));
                                carousel.addEventListener('mouseleave', () => interval = setInterval(next, 2000));

                                // Manual dot click
                                dots.forEach(d => d.addEventListener('click', (e) => {
                                    const idx = Number(e.currentTarget.getAttribute('data-dot'));
                                    show(idx);
                                }));
                            })();
                        </script>
                    </div>
                    <!-- Premio Mayor -->
                    <div class="col-span-1 bg-yellow-400/10 border border-yellow-400 rounded-lg p-5 text-center">
                        <h2 class="text-lg font-bold text-yellow-300 mb-2">Premio Mayor</h2>
                        <p class="text-sm text-gray-200 mb-3">El ganador podrá elegir UNA de las siguientes opciones:</p>
                        <p class="text-base font-semibold text-white">• ASUS TUF Gaming (Ryzen 7 / RTX 3050 / 16GB DDR5 / 500GB M.2)</p>
                        <p class="text-2xl font-bold text-green-400 my-2">o $3.500.000 COP</p>
                        <p class="text-sm text-gray-300">Para el que tenga el número ganador invertido, premio adicional:</p>
                        <p class="text-lg font-bold text-indigo-300 mt-2">$750.000</p>
                    </div>

                    <!-- Calendario de sorteos -->
                    <div class="col-span-2 bg-white/5 border border-white/20 rounded-lg p-4">
                        
                        <div class="space-y-3 text-sm text-gray-200">
                            <div class="p-3 bg-black/30 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-bold">28 de noviembre de 2025</p>
                                        <p class="text-gray-300 text-xs">Santander</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold text-green-300">COP 600.000</p>
                                        <p class="text-xs text-indigo-300">COP 200.000 (número invertido)</p>
                                    </div>
                                </div>
                            </div>

                            <div class="p-3 bg-black/30 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-bold">21 de noviembre de 2025</p>
                                        <p class="text-gray-300 text-xs">Santander</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold text-green-300">COP 500.000</p>
                                        <p class="text-xs text-indigo-300">COP 150.000 (número invertido)</p>
                                    </div>
                                </div>
                            </div>

                            <div class="p-3 bg-black/30 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-bold">14 de noviembre de 2025</p>
                                        <p class="text-gray-300 text-xs">Santander</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold text-green-300">COP 400.000</p>
                                        <p class="text-xs text-indigo-300">COP 100.000 (número invertido)</p>
                                    </div>
                                </div>
                            </div>

                            <div class="p-3 bg-black/30 rounded-lg">
                                <div class="flex justify-between items-center">
                                    <div>
                                        <p class="font-bold">7 de noviembre de 2025</p>
                                        <p class="text-gray-300 text-xs">Santander</p>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-semibold text-green-300">COP 350.000</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 max-w-3xl mx-auto">
                    <div class="bg-white/10 rounded-lg p-4">
                        <p class="text-sm text-gray-300">Valor boleta</p>
                        <p class="text-2xl font-bold">$30.000</p>
                        <p class="text-xs text-yellow-300 mt-1">Aparta desde $10.000</p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <p class="text-sm text-gray-300">Boletas vendidas</p>
                        <p class="text-2xl font-bold"><span id="soldPercentage">0</span>%</p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <p class="text-sm text-gray-300">Próximo sorteo</p>
                        <p class="text-lg font-bold" id="nextDrawDate">-</p>
                        <p class="text-xs text-gray-300">Sorteo Semanal</p>
                    </div>
                </div>

                <div class="mt-6 bg-red-600/20 border-2 border-red-400 rounded-lg p-4 max-w-md mx-auto">
                    <p class="text-sm font-semibold mb-2">⏰ Tiempo para el próximo sorteo</p>
                    <p id="countdown" class="text-3xl font-mono font-bold">Calculando...</p>
                </div>

                <div class="mt-4 bg-blue-500/20 border border-blue-400 rounded-lg p-3 max-w-2xl mx-auto">
                    <p class="text-sm">
                        💡 <strong>Bendiciones semanales + bendicion final</strong><br>
                        Para participar en la bendicion semanal 1: paga mínimo $15.000 antes del corte
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Botón Comprar -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="text-center mb-6">
            <button onclick="openPurchaseForm()" class="bg-gradient-to-r from-green-500 to-blue-500 hover:from-green-600 hover:to-blue-600 text-white font-bold py-4 px-8 rounded-lg text-xl shadow-lg transform hover:scale-105 transition-all">
                🎫 Comprar Prenda - $30.000
            </button>
        </div>

        <button onclick="showTerms()" class="w-full bg-white/10 hover:bg-white/20 rounded-lg p-4 mb-6 transition-all">
            📋 Ver Términos y Condiciones
        </button>
    </div>

    <!-- Modal Formulario Compra -->
    <div id="purchaseModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-gradient-to-br from-purple-800 to-blue-800 rounded-xl p-6 max-w-md w-full my-8">
            <h3 class="text-2xl font-bold mb-4">🎫 Comprar Boleta</h3>
            
            <div class="bg-yellow-400/20 border border-yellow-400 rounded-lg p-3 mb-4 text-sm">
                <p>💰 Valor total: $30.000</p>
                <p>✅ Aparta desde: $10.000</p>
                <p>🎯 Para sorteo semana 1: mínimo $15.000 antes del <span id="week1Cutoff">-</span></p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Nombre completo *</label>
                    <input type="text" id="inputName" required class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Correo electrónico *</label>
                    <input type="email" id="inputEmail" required class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Celular *</label>
                    <input type="tel" id="inputPhone" required placeholder="3001234567" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Dirección completa *</label>
                    <input type="text" id="inputAddress" required placeholder="Calle, Carrera, Barrio, Ciudad" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Método de pago *</label>
                    <select id="inputPayment" required class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                        <option value="">Seleccionar...</option>
                        <option value="Nequi">Nequi</option>
                        <option value="Llaves">Llaves</option>
                        <option value="Efectivo">Efectivo</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Monto a pagar (mínimo $10.000) *</label>
                    <input type="number" id="inputAmount" required min="10000" max="30000" value="10000" step="1000" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                    <p class="text-xs text-gray-300 mt-1">Valor total: $30.000</p>
                </div>

                <div class="bg-yellow-400/20 border border-yellow-400 rounded-lg p-4">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="inputTerms" required class="mt-1 w-5 h-5">
                        <span class="text-sm">
                            Acepto los términos. Recibiré mis números por correo. Los sorteos son semanales + final.
                        </span>
                    </label>
                </div>

                <div class="flex gap-3">
                    <button onclick="closePurchaseForm()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-3 rounded-lg font-semibold">
                        Cancelar
                    </button>
                    <button onclick="submitPurchase()" class="flex-1 bg-green-600 hover:bg-green-500 py-3 rounded-lg font-semibold">
                        Comprar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Éxito -->
    <div id="successModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div class="bg-green-600 rounded-xl p-8 max-w-md w-full text-center">
            <div class="text-6xl mb-4 animate-bounce">✅</div>
            <h3 class="text-2xl font-bold mb-4">¡Compra Registrada!</h3>
            <div class="bg-white/20 rounded-lg p-4 mb-4 text-left">
                <p class="font-bold text-center mb-2">Boleta #<span id="successTicketNum"></span></p>
                <p class="text-sm">📧 Recibirás un correo con tus números</p>
                <p class="text-sm mt-2">💰 Pagado: $<span id="successAmount"></span></p>
                <p class="text-sm">⏳ Pendiente: $<span id="successPending"></span></p>
            </div>
            <p class="text-sm">Envía tu comprobante al WhatsApp para confirmar</p>
        </div>
    </div>

    <!-- Modal Términos -->
    <div id="termsModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white text-gray-900 rounded-xl p-6 max-w-2xl w-full my-8">
            <h3 class="text-2xl font-bold mb-4">Términos y Condiciones</h3>
            <div class="space-y-4 text-sm max-h-96 overflow-y-auto">
                <section>
                    <h4 class="font-bold text-lg mb-2">1. Sistema de Bendiciones</h4>
                    <p>• 5 Bendiciones + 1 bendicion final (6 de diciembre 2025)</p>
                    <p>• Cada boleta tiene 2 números asignados aleatoriamente (000-999)</p>
                    <p>• El número invertido también participa</p>
                </section>
                <section>
                    <h4 class="font-bold text-lg mb-2">2. Pagos y Elegibilidad</h4>
                    <p>• Precio total: $30.000</p>
                    <p>• Puedes apartar con $10.000</p>
                    <p>• Para participar en bendicion semanal 1: mínimo $15.000 pagados antes del corte</p>
                    <p>• Recibirás notificación por correo cuando seas elegible</p>
                </section>
                <section>
                    <h4 class="font-bold text-lg mb-2">3. Números y Notificaciones</h4>
                    <p>• Tus números se envían por correo después de confirmar pago inicial</p>
                    <p>• No se muestran públicamente por seguridad</p>
                </section>
            </div>
            <button onclick="closeTerms()" class="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-semibold">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Panel Admin -->
    <div id="adminPanel" class="hidden fixed inset-0 bg-black/95 z-50 overflow-y-auto">
        <div class="max-w-7xl mx-auto p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">🔑 Panel Administrador</h2>
                <button onclick="toggleAdmin()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg">Cerrar</button>
            </div>

            <div id="adminLogin" class="bg-white/10 rounded-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-4">Contraseña</h3>
                <div class="flex gap-3">
                    <input type="password" id="adminPassword" placeholder="Contraseña" class="flex-1 px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                    <button onclick="loginAdmin()" class="bg-green-600 px-6 py-2 rounded-lg font-semibold">Entrar</button>
                </div>
            </div>

            <div id="adminContent" class="hidden space-y-6">
                <!-- Buscar Ganador -->
                <div class="bg-white/10 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">🎯 Buscar Ganador</h3>
                    <div class="flex gap-3">
                        <input type="number" id="winningNumber" placeholder="Ej: 347" min="0" max="999" class="flex-1 px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                        <button onclick="findWinner()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-semibold">Buscar</button>
                    </div>
                    <div id="winnerResult" class="mt-4"></div>
                </div>

                <!-- Registrar Abono Manual -->
                <div class="bg-white/10 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">💰 Registrar Abono Manual</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="manualTicketNum" placeholder="# Boleta" min="1" max="500" class="px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                        <input type="number" id="manualAmount" placeholder="Monto" min="1000" class="px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                        <button onclick="registerManualPayment()" class="col-span-2 bg-green-600 hover:bg-green-500 py-2 rounded-lg font-semibold">Registrar Pago</button>
                    </div>
                </div>

                <!-- Lista de Reservas -->
                <div class="bg-white/10 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">📋 Todas las Boletas</h3>
                    <div id="allTicketsList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-6 text-center text-sm text-gray-400">
        <p>Bendición Universitaria 2025</p>
        <p class="mt-2">WhatsApp: <span id="footerWhatsapp">+57 315 137 1553</span></p>
    </div>

    <script type="module">
/* ============================================
   CONFIGURACIÓN - CAMBIAR ESTOS VALORES
============================================ */

// 🔥 FIREBASE CONFIG (pega tu configuración aquí)
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getDatabase, ref, set, onValue, get, push, update } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBOuEPesCNGxWxKxcJuPbGnNHJArBuj7Nc",
    authDomain: "rifa-universitaria-657c8.firebaseapp.com",
    databaseURL: "https://rifa-universitaria-657c8-default-rtdb.firebaseio.com",
    projectId: "rifa-universitaria-657c8",
    storageBucket: "rifa-universitaria-657c8.firebasestorage.app",
    messagingSenderId: "173786953583",
    appId: "1:173786953583:web:7275693fc0948a65b35a9a"
};

// 📧 EMAILJS CONFIG (regístrate en emailjs.com y pega tus keys)
const EMAILJS_CONFIG = {
    serviceId: 'TU_SERVICE_ID',      // ⚠️ CAMBIAR
    templateId: 'TU_TEMPLATE_ID',    // ⚠️ CAMBIAR
    publicKey: 'TU_PUBLIC_KEY'       // ⚠️ CAMBIAR
};

// 💰 CONFIGURACIÓN DE PRECIOS Y ELEGIBILIDAD
const TICKET_PRICE = 30000;
const MIN_PAYMENT = 10000;
const eligibilityThresholds = {
    week1: 15000,
    week2: 10000,
    week3: 10000,
    week4: 10000,
    week5: 10000
};

// 📅 FECHAS DE SORTEOS (cutoff = fecha límite para ser elegible)
const weeklyCutoffs = {
    week1: new Date('2025-11-08T23:59:59'),
    week2: new Date('2025-11-15T23:59:59'),
    week3: new Date('2025-11-22T23:59:59'),
    week4: new Date('2025-11-29T23:59:59'),
    week5: new Date('2025-12-04T23:59:59')
};

const FINAL_DRAW_DATE = new Date('2025-12-06T20:00:00');
const WHATSAPP_NUMBER = '573151371553';
const ADMIN_PASSWORD = '210621#';
const TOTAL_TICKETS = 500;

/* ============================================
   INICIALIZACIÓN
============================================ */
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Inicializar EmailJS
emailjs.init(EMAILJS_CONFIG.publicKey);

// Pool de números disponibles (000-999)
let availableNumbers = [];
for (let i = 0; i <= 999; i++) {
    availableNumbers.push(String(i).padStart(3, '0'));
}

let isAdminLoggedIn = false;

/* ============================================
   FUNCIONES AUXILIARES
============================================ */

// Asignar 2 números aleatorios
function assignRandomNumbers() {
    if (availableNumbers.length < 2) {
        throw new Error('No hay suficientes números disponibles');
    }
    
    const nums = [];
    for (let i = 0; i < 2; i++) {
        const idx = Math.floor(Math.random() * availableNumbers.length);
        nums.push(availableNumbers[idx]);
        availableNumbers.splice(idx, 1);
    }
    return nums.sort();
}

// Calcular elegibilidad por semana
function calculateEligibility(amountPaid, paymentDate) {
    const eligible = {};
    const pDate = new Date(paymentDate);
    
    Object.keys(eligibilityThresholds).forEach(week => {
        const threshold = eligibilityThresholds[week];
        const cutoff = weeklyCutoffs[week];
        
        // Es elegible si: pagó suficiente Y el pago fue antes del cutoff
        eligible[week] = (amountPaid >= threshold) && (pDate <= cutoff);
    });
    
    return eligible;
}

// Calcular número invertido
function getInvertedNumber(num) {
    return num.split('').reverse().join('');
}

// Enviar correo con EmailJS
async function sendEmail(templateParams) {
    try {
        await emailjs.send(
            EMAILJS_CONFIG.serviceId,
            EMAILJS_CONFIG.templateId,
            templateParams
        );
        console.log('✅ Correo enviado');
    } catch (error) {
        console.error('❌ Error enviando correo:', error);
    }
}

/* ============================================
   ACTUALIZAR UI PÚBLICA
============================================ */
onValue(ref(db, 'tickets'), (snapshot) => {
    const data = snapshot.val() || {};
    const tickets = Object.values(data);
    
    const sold = tickets.filter(t => t.estadoPago === 'pagado' || t.amountPaid >= TICKET_PRICE).length;
    const percentage = Math.round((sold / TOTAL_TICKETS) * 100);
    
    document.getElementById('soldPercentage').textContent = percentage;
    document.getElementById('soldCount').textContent = `${sold} de ${TOTAL_TICKETS}`;
});

// Actualizar contador próximo sorteo
function updateCountdown() {
    const now = new Date();
    let nextDraw = null;
    
    // Buscar próximo sorteo
    Object.values(weeklyCutoffs).forEach(cutoff => {
        if (cutoff > now && (!nextDraw || cutoff < nextDraw)) {
            nextDraw = cutoff;
        }
    });
    
    if (!nextDraw) nextDraw = FINAL_DRAW_DATE;
    
    const diff = nextDraw - now;
    if (diff <= 0) {
        document.getElementById('countdown').textContent = '¡Sorteo!';
        return;
    }
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const secs = Math.floor((diff % (1000 * 60)) / 1000);
    
    document.getElementById('countdown').textContent = `${days}d ${hours}h ${mins}m ${secs}s`;
    document.getElementById('nextDrawDate').textContent = nextDraw.toLocaleDateString('es-CO');
}

setInterval(updateCountdown, 1000);
updateCountdown();

// Mostrar fecha de week1 cutoff en el form
document.getElementById('week1Cutoff').textContent = weeklyCutoffs.week1.toLocaleDateString('es-CO');

/* ============================================
   COMPRA DE BOLETAS
============================================ */
function openPurchaseForm() {
    document.getElementById('purchaseModal').classList.remove('hidden');
}

function closePurchaseForm() {
    document.getElementById('purchaseModal').classList.add('hidden');
}

async function submitPurchase() {
    const name = document.getElementById('inputName').value.trim();
    const email = document.getElementById('inputEmail').value.trim();
    const phone = document.getElementById('inputPhone').value.trim();
    const address = document.getElementById('inputAddress').value.trim();
    const payment = document.getElementById('inputPayment').value;
    const amount = parseInt(document.getElementById('inputAmount').value);
    const terms = document.getElementById('inputTerms').checked;
    
    if (!name || !email || !phone || !address || !payment) {
        alert('❌ Completa todos los campos');
        return;
    }
    
    if (!terms) {
        alert('❌ Debes aceptar los términos');
        return;
    }
    
    if (amount < MIN_PAYMENT || amount > TICKET_PRICE) {
        alert(`❌ Monto debe estar entre $${MIN_PAYMENT.toLocaleString('es-CO')} y $${TICKET_PRICE.toLocaleString('es-CO')}`);
        return;
    }
    
    try {
        // Generar número de boleta
        const snapshot = await get(ref(db, 'tickets'));
        const existingTickets = snapshot.val() || {};
        const ticketNumber = Object.keys(existingTickets).length + 1;
        
        if (ticketNumber > TOTAL_TICKETS) {
            alert('❌ Ya no hay boletas disponibles');
            return;
        }
        
        // Asignar números aleatorios
        const assignedNumbers = assignRandomNumbers();
        const now = new Date().toISOString();
        const eligible = calculateEligibility(amount, now);
        
        // Crear ticket
        const ticketData = {
            ticketNumber,
            numerosAsignados: assignedNumbers,
            nombre: name,
            correo: email,
            telefono: phone,
            direccion: address,
            amountPaid: amount,
            montoTotal: TICKET_PRICE,
            estadoPago: amount >= TICKET_PRICE ? 'pagado' : 'abonado',
            metodoPago: payment,
            reservedAt: now,
            lastPaymentAt: now,
            eligible: eligible,
            payments: [{ amount, date: now }]
        };
        
        // Guardar en Firebase
        await set(ref(db, `tickets/ticket_${ticketNumber}`), ticketData);
        
        // Mostrar éxito
        document.getElementById('successTicketNum').textContent = ticketNumber;
        document.getElementById('successAmount').textContent = amount.toLocaleString('es-CO');
        document.getElementById('successPending').textContent = (TICKET_PRICE - amount).toLocaleString('es-CO');
        document.getElementById('successModal').classList.remove('hidden');
        
        // Enviar correo
        const eligibleWeeks = Object.keys(eligible).filter(w => eligible[w]).join(', ') || 'Ninguna aún';
        const pending = TICKET_PRICE - amount;
        
        await sendEmail({
            to_email: email,
            to_name: name,
            ticket_number: ticketNumber,
            assigned_numbers: `${assignedNumbers[0]} y ${assignedNumbers[1]}`,
            inverted1: getInvertedNumber(assignedNumbers[0]),
            inverted2: getInvertedNumber(assignedNumbers[1]),
            amount_paid: amount.toLocaleString('es-CO'),
            pending_amount: pending.toLocaleString('es-CO'),
            eligible_weeks: eligibleWeeks,
            week1_threshold: eligibilityThresholds.week1.toLocaleString('es-CO'),
            week1_cutoff: weeklyCutoffs.week1.toLocaleDateString('es-CO')
        });
        
        // Cerrar modales
        setTimeout(() => {
            document.getElementById('successModal').classList.add('hidden');
            closePurchaseForm();
            
            // Limpiar form
            document.getElementById('inputName').value = '';
            document.getElementById('inputEmail').value = '';
            document.getElementById('inputPhone').value = '';
            document.getElementById('inputAddress').value = '';
            document.getElementById('inputPayment').value = '';
            document.getElementById('inputAmount').value = '10000';
            document.getElementById('inputTerms').checked = false;
        }, 5000);
        
    } catch (error) {
        console.error('Error:', error);
        alert('❌ Error al procesar la compra: ' + error.message);
    }
}

/* ============================================
   PANEL ADMIN
============================================ */
function checkAdminAccess() {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('admin') === 'true' || window.location.hash === '#admin') {
        document.getElementById('adminPanel').classList.remove('hidden');
    }
}

function toggleAdmin() {
    document.getElementById('adminPanel').classList.toggle('hidden');
}

function loginAdmin() {
    if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
        isAdminLoggedIn = true;
        document.getElementById('adminLogin').classList.add('hidden');
        document.getElementById('adminContent').classList.remove('hidden');
        loadAllTickets();
    } else {
        alert('❌ Contraseña incorrecta');
    }
}

async function loadAllTickets() {
    const snapshot = await get(ref(db, 'tickets'));
    const data = snapshot.val() || {};
    const tickets = Object.values(data);
    
    const list = document.getElementById('allTicketsList');
    if (tickets.length === 0) {
        list.innerHTML = '<p class="text-gray-400">No hay boletas</p>';
        return;
    }
    
    list.innerHTML = tickets.map(t => {
        const pending = TICKET_PRICE - t.amountPaid;
        const percent = Math.round((t.amountPaid / TICKET_PRICE) * 100);
        const eligibleWeeks = Object.keys(t.eligible || {}).filter(w => t.eligible[w]);
        
        return `
            <div class="bg-gray-800 rounded-lg p-4 border ${t.estadoPago === 'pagado' ? 'border-green-500' : 'border-yellow-500'}">
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <p class="font-bold text-lg">Boleta #${t.ticketNumber}</p>
                        <p class="text-sm text-gray-300">🔢 ${t.numerosAsignados[0]} y ${t.numerosAsignados[1]}</p>
                        <p class="text-xs text-gray-400">🔄 Inv: ${getInvertedNumber(t.numerosAsignados[0])} y ${getInvertedNumber(t.numerosAsignados[1])}</p>
                    </div>
                    <span class="px-3 py-1 rounded text-xs font-bold ${t.estadoPago === 'pagado' ? 'bg-green-500' : 'bg-yellow-500'}">
                        ${t.estadoPago.toUpperCase()}
                    </span>
                </div>
                
                <div class="bg-black/30 rounded p-3 mb-3 text-sm">
                    <div class="flex justify-between mb-1">
                        <span>Pagado:</span>
                        <span class="font-bold text-green-400">${t.amountPaid.toLocaleString('es-CO')}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span>Pendiente:</span>
                        <span class="font-bold text-red-400">${pending.toLocaleString('es-CO')}</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full transition-all" style="width: ${percent}%"></div>
                    </div>
                    <p class="text-xs text-center mt-1">${percent}% pagado</p>
                </div>
                
                <div class="text-sm space-y-1 mb-3">
                    <p>👤 ${t.nombre}</p>
                    <p>📧 ${t.correo}</p>
                    <p>📱 ${t.telefono}</p>
                    <p>📍 ${t.direccion}</p>
                    <p>💳 ${t.metodoPago}</p>
                    <p>🕐 ${new Date(t.reservedAt).toLocaleString('es-CO')}</p>
                </div>
                
                <div class="bg-blue-900/30 rounded p-2 mb-3 text-xs">
                    <p class="font-bold mb-1">✅ Elegible para:</p>
                    ${eligibleWeeks.length > 0 
                        ? eligibleWeeks.map(w => `<span class="inline-block bg-green-600 px-2 py-1 rounded mr-1 mb-1">${w}</span>`).join('')
                        : '<span class="text-gray-400">Ningúna bendicion aún</span>'
                    }
                </div>
                
                <div class="flex gap-2 flex-wrap">
                    <button onclick="registerManualPaymentFor(${t.ticketNumber})" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 px-3 rounded text-sm font-semibold">
                        💰 Abonar
                    </button>
                    <button onclick="sendEligibilityEmail('${t.correo}', ${t.ticketNumber})" class="flex-1 bg-purple-600 hover:bg-purple-500 py-2 px-3 rounded text-sm font-semibold">
                        📧 Email
                    </button>
                    <button onclick="deleteTicket(${t.ticketNumber})" class="bg-red-600 hover:bg-red-500 py-2 px-3 rounded text-sm font-semibold">
                        🗑️
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// Registrar abono manual desde el formulario general
async function registerManualPayment() {
    const ticketNum = parseInt(document.getElementById('manualTicketNum').value);
    const amount = parseInt(document.getElementById('manualAmount').value);
    
    if (!ticketNum || !amount || amount < 1000) {
        alert('❌ Ingresa número de boleta y monto válidos');
        return;
    }
    
    await registerPaymentForTicket(ticketNum, amount);
    
    // Limpiar
    document.getElementById('manualTicketNum').value = '';
    document.getElementById('manualAmount').value = '';
}

// Registrar pago para una boleta específica
async function registerManualPaymentFor(ticketNumber) {
    const amount = prompt(`Ingresa el monto del abono para la Boleta #${ticketNumber}:`, '5000');
    if (!amount) return;
    
    const parsedAmount = parseInt(amount);
    if (isNaN(parsedAmount) || parsedAmount < 1000) {
        alert('❌ Monto inválido');
        return;
    }
    
    await registerPaymentForTicket(ticketNumber, parsedAmount);
}

// Lógica central de registro de pago
async function registerPaymentForTicket(ticketNumber, amount) {
    try {
        const ticketRef = ref(db, `tickets/ticket_${ticketNumber}`);
        const snapshot = await get(ticketRef);
        
        if (!snapshot.exists()) {
            alert('❌ Boleta no encontrada');
            return;
        }
        
        const ticket = snapshot.val();
        const previousAmount = ticket.amountPaid;
        const newAmount = previousAmount + amount;
        const now = new Date().toISOString();
        
        // Calcular nueva elegibilidad
        const newEligibility = calculateEligibility(newAmount, now);
        
        // Detectar nuevas semanas elegibles
        const previouslyEligible = Object.keys(ticket.eligible || {}).filter(w => ticket.eligible[w]);
        const nowEligible = Object.keys(newEligibility).filter(w => newEligibility[w]);
        const newlyEligible = nowEligible.filter(w => !previouslyEligible.includes(w));
        
        // Actualizar ticket
        const updates = {
            amountPaid: newAmount,
            estadoPago: newAmount >= TICKET_PRICE ? 'pagado' : 'abonado',
            lastPaymentAt: now,
            eligible: newEligibility
        };
        
        // Agregar pago al historial
        const payments = ticket.payments || [];
        payments.push({ amount, date: now });
        updates.payments = payments;
        
        await update(ticketRef, updates);
        
        alert(`✅ Abono registrado: ${amount.toLocaleString('es-CO')}\nTotal: ${newAmount.toLocaleString('es-CO')}`);
        
        // Si hay nuevas semanas elegibles, enviar correo
        if (newlyEligible.length > 0) {
            await sendEmail({
                to_email: ticket.correo,
                to_name: ticket.nombre,
                ticket_number: ticket.ticketNumber,
                assigned_numbers: `${ticket.numerosAsignados[0]} y ${ticket.numerosAsignados[1]}`,
                amount_paid: newAmount.toLocaleString('es-CO'),
                pending_amount: (TICKET_PRICE - newAmount).toLocaleString('es-CO'),
                eligible_weeks: newlyEligible.join(', '),
                message_type: 'elegibilidad'
            });
        }
        
        loadAllTickets();
        
    } catch (error) {
        console.error('Error:', error);
        alert('❌ Error al registrar pago: ' + error.message);
    }
}

// Buscar ganador
async function findWinner() {
    const number = document.getElementById('winningNumber').value.padStart(3, '0');
    const inverted = getInvertedNumber(number);
    
    const snapshot = await get(ref(db, 'tickets'));
    const data = snapshot.val() || {};
    const tickets = Object.values(data);
    
    const winners = tickets.filter(t => 
        t.numerosAsignados.includes(number) || t.numerosAsignados.includes(inverted)
    );
    
    const resultDiv = document.getElementById('winnerResult');
    
    if (winners.length === 0) {
        resultDiv.innerHTML = `
            <div class="bg-red-600/30 border border-red-500 rounded p-4">
                <p class="font-bold">❌ No se encontró ganador</p>
                <p class="text-sm">Número: ${number} | Invertido: ${inverted}</p>
            </div>
        `;
        return;
    }
    
    resultDiv.innerHTML = `
        <div class="bg-green-600/30 border border-green-500 rounded p-4">
            <p class="font-bold text-xl mb-3">🎉 ¡Ganador(es) Encontrado(s)!</p>
            <p class="text-sm mb-2">Número: ${number} | Invertido: ${inverted}</p>
            ${winners.map(w => `
                <div class="bg-black/30 rounded p-3 mb-2">
                    <p class="font-bold">Boleta #${w.ticketNumber}</p>
                    <p class="text-sm">🔢 Números: ${w.numerosAsignados[0]} y ${w.numerosAsignados[1]}</p>
                    <p class="text-sm">👤 ${w.nombre}</p>
                    <p class="text-sm">📧 ${w.correo}</p>
                    <p class="text-sm">📱 ${w.telefono}</p>
                    <p class="text-sm">📍 ${w.direccion}</p>
                    <p class="text-sm font-bold ${w.estadoPago === 'pagado' ? 'text-green-400' : 'text-yellow-400'}">
                        💰 ${w.estadoPago === 'pagado' ? 'PAGADO COMPLETO' : `Abonado ${w.amountPaid.toLocaleString('es-CO')}`}
                    </p>
                </div>
            `).join('')}
        </div>
    `;
}

// Enviar email de elegibilidad manual
async function sendEligibilityEmail(email, ticketNumber) {
    const snapshot = await get(ref(db, `tickets/ticket_${ticketNumber}`));
    if (!snapshot.exists()) return;
    
    const ticket = snapshot.val();
    const eligibleWeeks = Object.keys(ticket.eligible || {}).filter(w => ticket.eligible[w]);
    
    await sendEmail({
        to_email: email,
        to_name: ticket.nombre,
        ticket_number: ticket.ticketNumber,
        assigned_numbers: `${ticket.numerosAsignados[0]} y ${ticket.numerosAsignados[1]}`,
        inverted1: getInvertedNumber(ticket.numerosAsignados[0]),
        inverted2: getInvertedNumber(ticket.numerosAsignados[1]),
        amount_paid: ticket.amountPaid.toLocaleString('es-CO'),
        pending_amount: (TICKET_PRICE - ticket.amountPaid).toLocaleString('es-CO'),
        eligible_weeks: eligibleWeeks.join(', ') || 'Ninguna',
        message_type: 'recordatorio'
    });
    
    alert('✅ Correo enviado');
}

// Eliminar boleta
async function deleteTicket(ticketNumber) {
    if (!confirm(`¿Eliminar la Boleta #${ticketNumber}?`)) return;
    
    try {
        const ticketRef = ref(db, `tickets/ticket_${ticketNumber}`);
        const snapshot = await get(ticketRef);
        
        if (snapshot.exists()) {
            const ticket = snapshot.val();
            // Devolver números al pool
            ticket.numerosAsignados.forEach(num => {
                if (!availableNumbers.includes(num)) {
                    availableNumbers.push(num);
                }
            });
            
            await set(ticketRef, null);
            alert('✅ Boleta eliminada');
            loadAllTickets();
        }
    } catch (error) {
        alert('❌ Error: ' + error.message);
    }
}

/* ============================================
   FUNCIONES GLOBALES
============================================ */
function showTerms() {
    document.getElementById('termsModal').classList.remove('hidden');
}

function closeTerms() {
    document.getElementById('termsModal').classList.add('hidden');
}

// Exponer funciones al scope global
window.openPurchaseForm = openPurchaseForm;
window.closePurchaseForm = closePurchaseForm;
window.submitPurchase = submitPurchase;
window.showTerms = showTerms;
window.closeTerms = closeTerms;
window.checkAdminAccess = checkAdminAccess;
window.toggleAdmin = toggleAdmin;
window.loginAdmin = loginAdmin;
window.loadAllTickets = loadAllTickets;
window.registerManualPayment = registerManualPayment;
window.registerManualPaymentFor = registerManualPaymentFor;
window.findWinner = findWinner;
window.sendEligibilityEmail = sendEligibilityEmail;
window.deleteTicket = deleteTicket;

// Iniciar
checkAdminAccess();

    </script>
</body>
</html>