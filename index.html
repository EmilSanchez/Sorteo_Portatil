<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rifa Universitaria - Port√°til Gamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce { animation: bounce 1s infinite; }
        
        body {
            background: linear-gradient(135deg, #2a0168 0%, #182f6e 50%, #222058 100%);
            min-height: 100vh;
        }
        
        .ticket-card {
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .ticket-card:hover:not(:disabled) {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="text-white">
    <!-- Header -->
    <div class="bg-black/30 backdrop-blur-md shadow-xl">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="text-center">
                <h1 class="text-4xl font-bold mb-2 flex items-center justify-center gap-3">
                    Sorteo con el fin de recoger fondos Universitarios
                </h1>
                <p class="text-xl text-yellow-300 font-semibold mb-4">
                    Premio: ASUS TUF Gaming Ryzen 7 / RTX 3050 / 16GB RAM DDR5 / 500GB M.2
                </p>
                <p class="text-2xl font-bold text-green-400">
                    o $3.000.000 COP en efectivo (a elecci√≥n del ganador)
                </p>
                
                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 max-w-3xl mx-auto">
                    <div class="bg-white/10 rounded-lg p-4">
                        <p class="text-sm text-gray-300">Valor boleta</p>
                        <p class="text-2xl font-bold">$25.000</p>
                        <p class="text-xs text-yellow-300 mt-1">Aparta con $5.000</p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <p class="text-sm text-gray-300">Total boletas</p>
                        <p class="text-2xl font-bold">500</p>
                        <p class="text-xs text-gray-400 mt-1">2 n√∫meros por boleta</p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <p class="text-sm text-gray-300">Sorteo</p>
                        <p class="text-lg font-bold">6 de diciembre 2025</p>
                        <p class="text-xs text-gray-300">Loter√≠a de Santander</p>
                    </div>
                </div>

                <div class="mt-6 bg-red-600/20 border-2 border-red-400 rounded-lg p-4 max-w-md mx-auto">
                    <div class="flex items-center justify-center gap-2 mb-2">
                         <p class="text-sm font-semibold">Tiempo restante para el sorteo</p>
                    </div>
                    <p id="countdown" class="text-3xl font-mono font-bold">Calculando...</p>
                </div>

                <div class="mt-4 bg-blue-500/20 border border-blue-400 rounded-lg p-3 max-w-2xl mx-auto">
                    <p class="text-sm">
                         <strong>¬°Doble oportunidad!</strong> Cada boleta incluye 2 n√∫meros (000-499 y 500-999)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-green-600/20 border border-green-400 rounded-lg p-4 text-center">
                <p id="availableCount" class="text-3xl font-bold">500</p>
                <p class="text-sm">Disponibles</p>
            </div>
            <div class="bg-yellow-600/20 border border-yellow-400 rounded-lg p-4 text-center">
                <p id="reservedCount" class="text-3xl font-bold">0</p>
                <p class="text-sm">Reservadas</p>
            </div>
            <div class="bg-red-600/20 border border-red-400 rounded-lg p-4 text-center">
                <p id="soldCount" class="text-3xl font-bold">0</p>
                <p class="text-sm">Vendidas</p>
            </div>
        </div>

        <!-- Grilla de boletas -->
        <div class="bg-white/10 backdrop-blur-md rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                üé´ Selecciona tu boleta
            </h2>
            <div id="ticketsGrid" class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8 gap-2">
                <!-- Las boletas se generar√°n con JavaScript -->
            </div>
        </div>

        <button onclick="showTerms()" class="w-full bg-white/10 hover:bg-white/20 rounded-lg p-4 mb-6 transition-all">
            üìã Ver T√©rminos y Condiciones
        </button>
    </div>

    <!-- Modal Formulario -->
    <div id="formModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="bg-gradient-to-br from-purple-800 to-blue-800 rounded-xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-2">
                Reservar Boleta #<span id="selectedTicketNum"></span>
            </h3>
            <p class="text-yellow-300 mb-4 text-sm">
                üìå N√∫meros: <strong><span id="selectedNumbers"></span></strong>
            </p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Nombre completo</label>
                    <input type="text" id="inputName" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Correo electr√≥nico</label>
                    <input type="email" id="inputEmail" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Celular</label>
                    <input type="tel" id="inputPhone" placeholder="3103535483" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Direcci√≥n completa</label>
                    <input type="text" id="inputAddress" placeholder="Calle, Carrera, Barrio, Ciudad" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">M√©todo de pago</label>
                    <select id="inputPayment" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                        <option value="" style="color: #000;">Seleccionar...</option>
                        <option value="Nequi" style="color: #000;">Nequi</option>
                        <option value="Llaves" style="color: #000;">Llaves</option>
                        <option value="Efectivo" style="color: #000;">Efectivo</option>
                        <option value="Otro" style="color: #000;">Otro</option>
                    </select>

                    <div id="paymentInfo" class="mt-3 text-sm bg-white/10 rounded-lg p-3 hidden">
                        <div class="font-semibold mb-1">Instrucciones de pago</div>
                        <div id="paymentDetails" class="font-mono"></div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Monto a pagar (m√≠nimo $5.000 para apartar)</label>
                    <input type="number" id="inputAmount" min="5000" max="25000" value="5000" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                    <p class="text-xs text-gray-300 mt-1">Valor total: $25.000 - Puedes apartar con $5.000</p>
                </div>

                <div class="bg-yellow-400/20 border border-yellow-400 rounded-lg p-4">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="inputTerms" class="mt-1 w-5 h-5">
                        <span class="text-sm">
                            Acepto los t√©rminos y condiciones. Entiendo que tengo 24 horas para enviar el comprobante del abono inicial ($5.000 m√≠nimo) y hasta el 4 de diciembre de 2025 para completar el pago total de $25.000.
                        </span>
                    </label>
                </div>

                <div class="flex gap-3">
                    <button onclick="closeForm()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-3 rounded-lg font-semibold transition-all">
                        Cancelar
                    </button>
                    <button onclick="submitReservation()" class="flex-1 bg-green-600 hover:bg-green-500 py-3 rounded-lg font-semibold transition-all">
                        Reservar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal T√©rminos -->
    <div id="termsModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="bg-white text-gray-900 rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4">T√©rminos y Condiciones</h3>
            
            <div class="space-y-4 text-sm">
                <section>
                    <h4 class="font-bold text-lg mb-2">1. Del Premio</h4>
                    <p>El ganador podr√° elegir entre:</p>
                    <ul class="list-disc ml-6 mt-2">
                        <li>Port√°til ASUS TUF Gaming Ryzen 7 / RTX 3050 / 16GB RAM DDR5 / 500GB M.2</li>
                        <li>$3.000.000 COP en efectivo</li>
                    </ul>
                    <p class="mt-2">La elecci√≥n debe realizarse en un plazo m√°ximo de 24 horas despu√©s del sorteo.</p>
                </section>

                <section>
                    <h4 class="font-bold text-lg mb-2">2. Del Pago</h4>
                    <p>El valor total de cada boleta es $25.000 COP. Puedes apartar tu boleta con un pago m√≠nimo de $5.000 COP y completar el saldo antes del sorteo.</p>
                </section>

                <section>
                    <h4 class="font-bold text-lg mb-2">3. De las Boletas</h4>
                    <p>Cada boleta incluye 2 n√∫meros autom√°ticamente asignados, duplicando tus oportunidades de ganar.</p>
                </section>

                <section>
                    <h4 class="font-bold text-lg mb-2">3. De la Reserva y Pagos</h4>
                    <p><strong>Abono inicial:</strong> Puedes apartar tu boleta con un pago m√≠nimo de $5.000 COP. Tienes 24 horas para enviar el comprobante de este abono inicial, de lo contrario la reserva ser√° liberada.</p>
                    <p class="mt-2"><strong>Pago total:</strong> El valor completo de la boleta ($25.000 COP) debe estar pagado completamente antes del 4 de diciembre de 2025 a las 11:59 PM. Puedes hacer abonos parciales durante este per√≠odo.</p>
                    <p class="mt-2"><strong>Importante:</strong> Solo participan en el sorteo las boletas que est√©n pagadas en su totalidad antes de la fecha l√≠mite.</p>
                </section>

                <section>
                    <h4 class="font-bold text-lg mb-2">4. Del Sorteo</h4>
                    <p>El sorteo se realizar√° el 6 de diciembre de 2025, siguiendo los resultados de la Loter√≠a de Santander.</p>
                </section>

                <section>
                    <h4 class="font-bold text-lg mb-2">5. De la Entrega</h4>
                    <p>El premio ser√° entregado dentro de los 5 d√≠as h√°biles siguientes al sorteo, previa validaci√≥n del boleto ganador y presentaci√≥n de documento de identidad.</p>
                </section>
            </div>

            <button onclick="closeTerms()" class="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-semibold transition-all">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal √âxito -->
    <div id="successModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="bg-green-600 rounded-xl p-8 max-w-md w-full text-center">
            <div class="text-6xl mb-4 animate-bounce">‚úÖ</div>
            <h3 class="text-2xl font-bold mb-4">Reserva Registrada</h3>
            <div class="bg-white/20 rounded-lg p-3 mb-4">
                <p class="font-bold">Boleta #<span id="successTicketNum"></span></p>
                <p class="text-sm">N√∫meros: <span id="successNumbers"></span></p>
                <p class="text-sm mt-2">Pagado: $<span id="successAmount"></span> de $25.000</p>
            </div>
            <p class="mb-4">
                Env√≠a tu comprobante al WhatsApp <strong id="whatsappDisplay"></strong> para validar tu participaci√≥n.
            </p>
            <p class="text-sm bg-white/20 rounded-lg p-3">
                Tienes 24 horas para enviar el comprobante del abono inicial. El pago completo debe estar antes del 4 de diciembre 2025.
            </p>
        </div>
    </div>

    <!-- Panel Admin -->
    <div id="adminPanel" class="hidden fixed inset-0 bg-black/90 z-50 overflow-y-auto">
        <div class="max-w-6xl mx-auto p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-white">üîë Panel de Administraci√≥n</h2>
                <button onclick="toggleAdmin()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg">
                    Cerrar
                </button>
            </div>

            <div id="adminLogin" class="bg-white/10 backdrop-blur-md rounded-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-4">Ingresa la contrase√±a de administrador</h3>
                <div class="flex gap-3">
                    <input type="password" id="adminPassword" placeholder="Contrase√±a" class="flex-1 px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                    <button onclick="loginAdmin()" class="bg-green-600 hover:bg-green-500 px-6 py-2 rounded-lg font-semibold">
                        Entrar
                    </button>
                </div>
            </div>

            <div id="adminContent" class="hidden">
                <div class="bg-white/10 backdrop-blur-md rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">üìã Boletas Reservadas (Pendientes de Pago Completo)</h3>
                    <div id="reservedList" class="space-y-3"></div>
                </div>

                <div class="bg-white/10 backdrop-blur-md rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4 text-green-400">‚úÖ Boletas Pagadas Completamente</h3>
                    <div id="soldList" class="space-y-3"></div>
                </div>

                <div class="bg-white/10 backdrop-blur-md rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">üóëÔ∏è Liberar Boleta Manualmente</h3>
                    <div class="flex gap-3">
                        <input type="number" id="ticketToFree" placeholder="N√∫mero de boleta" min="1" max="500" class="flex-1 px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                        <button onclick="freeTicket()" class="bg-red-600 hover:bg-red-500 px-6 py-2 rounded-lg font-semibold">
                            Liberar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Actualizar Pago -->
    <div id="updatePaymentModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div class="bg-gradient-to-br from-blue-800 to-purple-800 rounded-xl p-6 max-w-md w-full">
            <h3 class="text-2xl font-bold mb-4">üí∞ Actualizar Pago - Boleta #<span id="updateTicketNum"></span></h3>
            <div class="space-y-4">
                <div class="bg-white/10 rounded-lg p-3">
                    <p class="text-sm">Pagado actual: $<span id="currentPaid"></span></p>
                    <p class="text-sm">Pendiente: $<span id="pendingAmount"></span></p>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-2">Nuevo monto total pagado</label>
                    <input type="number" id="newAmountInput" min="0" max="25000" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                </div>
                <div class="flex gap-3">
                    <button onclick="closeUpdatePayment()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-3 rounded-lg font-semibold">
                        Cancelar
                    </button>
                    <button onclick="saveUpdatedPayment()" class="flex-1 bg-green-600 hover:bg-green-500 py-3 rounded-lg font-semibold">
                        Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="max-w-7xl mx-auto px-4 py-6 text-center text-sm text-gray-400">
        <p>Rifa Universitaria 2025 ‚Ä¢ Todas las transacciones deben ser validadas</p>
        <p class="mt-2">WhatsApp: <span id="footerWhatsapp"></span></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, remove } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

        const WHATSAPP_NUMBER = '573151371553';
        const DRAW_DATE = new Date('2025-12-06T20:00:00');
        const PAYMENT_DEADLINE = new Date('2025-12-04T23:59:59'); // Fecha l√≠mite pago completo
        const TICKET_PRICE = 25000;
        const TOTAL_TICKETS = 500;
        const ADMIN_PASSWORD = '210621#';
        const MIN_RESERVATION_PAYMENT = 5000;

        const firebaseConfig = {
            apiKey: "AIzaSyBOuEPesCNGxWxKxcJuPbGnNHJArBuj7Nc",
            authDomain: "rifa-universitaria-657c8.firebaseapp.com",
            databaseURL: "https://rifa-universitaria-657c8-default-rtdb.firebaseio.com",
            projectId: "rifa-universitaria-657c8",
            storageBucket: "rifa-universitaria-657c8.firebasestorage.app",
            messagingSenderId: "173786953583",
            appId: "1:173786953583:web:7275693fc0948a65b35a9a",
            measurementId: "G-H97SMY9BK5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const RESERVES_PATH = 'rifa/reservas';

        let tickets = [];
        let selectedTicket = null;
        let isAdminLoggedIn = false;
        let currentUpdateTicket = null;

        const paymentAccounts = {
            Nequi: 'Nequi: 3167862046 (Maria Martinez)',
            Llaves: 'Llaves: 3167862046 (Maria Martinez)',
            Efectivo: 'Efectivo: Coordinar por WhatsApp',
            Otro: 'Otro: Describe en WhatsApp'
        };

        function buildInitialTickets() {
            tickets = [];
            for (let i = 0; i < TOTAL_TICKETS; i++) {
                const ticketNum = i + 1;
                const firstNumber = String(i).padStart(3, '0');
                const secondNumber = String(999 - i).padStart(3, '0');
                tickets.push({
                    ticketNumber: ticketNum,
                    numbers: [firstNumber, secondNumber],
                    status: 'available',
                    buyer: null,
                    reservedAt: null,
                    amountPaid: 0
                });
            }
        }

        function renderTickets() {
            const grid = document.getElementById('ticketsGrid');
            grid.innerHTML = '';
            tickets.forEach(ticket => {
                const button = document.createElement('button');
                button.className = `ticket-card rounded-lg p-3 font-bold transition-all text-left ${
                    ticket.status === 'available' 
                        ? 'bg-green-500 hover:bg-blue-400 cursor-pointer shadow-lg' 
                        : ticket.status === 'reserved'
                        ? 'bg-yellow-600 cursor-not-allowed opacity-60'
                        : 'bg-red-600 cursor-not-allowed opacity-60'
                }`;
                button.disabled = ticket.status !== 'available';
                button.onclick = () => openForm(ticket);
                button.innerHTML = `
                    <div class="text-base mb-1">Boleta #${ticket.ticketNumber}</div>
                    <div class="text-xs font-normal opacity-100">${ticket.numbers[0]}-${ticket.numbers[1]}</div>
                `;
                grid.appendChild(button);
            });
            updateStats();
        }

        function updateStats() {
            const available = tickets.filter(t => t.status === 'available').length;
            const reserved = tickets.filter(t => t.status === 'reserved').length;
            const sold = tickets.filter(t => t.status === 'sold').length;
            document.getElementById('availableCount').textContent = available;
            document.getElementById('reservedCount').textContent = reserved;
            document.getElementById('soldCount').textContent = sold;
        }

        function openForm(ticket) {
            selectedTicket = ticket;
            document.getElementById('selectedTicketNum').textContent = ticket.ticketNumber;
            document.getElementById('selectedNumbers').textContent = `${ticket.numbers[0]} y ${ticket.numbers[1]}`;
            document.getElementById('formModal').classList.remove('hidden');
        }

        function closeForm() {
            document.getElementById('formModal').classList.add('hidden');
            selectedTicket = null;
            document.getElementById('inputName').value = '';
            document.getElementById('inputEmail').value = '';
            document.getElementById('inputPhone').value = '';
            document.getElementById('inputAddress').value = '';
            document.getElementById('inputPayment').value = '';
            document.getElementById('inputAmount').value = '5000';
            document.getElementById('inputTerms').checked = false;
        }

        async function firebaseSaveTicket(ticket) {
            const key = 'boleta_' + ticket.ticketNumber;
            await set(ref(db, `${RESERVES_PATH}/${key}`), ticket);
        }

        async function firebaseRemoveTicket(ticketNumber) {
            const key = 'boleta_' + ticketNumber;
            await remove(ref(db, `${RESERVES_PATH}/${key}`));
        }

        onValue(ref(db, RESERVES_PATH), (snapshot) => {
            const data = snapshot.val() || {};
            buildInitialTickets();
            Object.keys(data).forEach(key => {
                const t = data[key];
                const match = key.match(/^boleta_(\d+)$/);
                if (!match) return;
                const ticketNumber = parseInt(match[1], 10);
                const idx = tickets.findIndex(x => x.ticketNumber === ticketNumber);
                if (idx !== -1) {
                    tickets[idx] = {
                        ticketNumber: ticketNumber,
                        numbers: t.numbers || tickets[idx].numbers,
                        status: t.status || tickets[idx].status,
                        buyer: t.buyer || null,
                        reservedAt: t.reservedAt || null,
                        amountPaid: t.amountPaid || 0
                    };
                }
            });
            renderTickets();
        });

        function submitReservation() {
            const name = document.getElementById('inputName').value.trim();
            const email = document.getElementById('inputEmail').value.trim();
            const phone = document.getElementById('inputPhone').value.trim();
            const address = document.getElementById('inputAddress').value.trim();
            const payment = document.getElementById('inputPayment').value;
            const amount = parseInt(document.getElementById('inputAmount').value);
            const terms = document.getElementById('inputTerms').checked;

            if (!name || !email || !phone || !address || !payment) {
                alert('Por favor completa todos los campos');
                return;
            }
            if (!terms) {
                alert('Debes aceptar los t√©rminos y condiciones');
                return;
            }
            if (isNaN(amount) || amount < MIN_RESERVATION_PAYMENT) {
                alert(`El monto m√≠nimo para apartar es $${MIN_RESERVATION_PAYMENT.toLocaleString('es-CO')} COP`);
                return;
            }

            const ticketIndex = tickets.findIndex(t => t.ticketNumber === selectedTicket.ticketNumber);
            const ticket = tickets[ticketIndex];
            ticket.status = 'reserved';
            ticket.buyer = { name, email, phone, address, paymentMethod: payment };
            ticket.reservedAt = new Date().toISOString();
            ticket.amountPaid = amount;
            ticket.initialPaymentConfirmed = false; // Para rastrear si confirm√≥ el abono inicial

            firebaseSaveTicket(ticket).then(() => {
                document.getElementById('successTicketNum').textContent = ticket.ticketNumber;
                document.getElementById('successNumbers').textContent = `${ticket.numbers[0]} y ${ticket.numbers[1]}`;
                document.getElementById('successAmount').textContent = amount.toLocaleString('es-CO');
                document.getElementById('successModal').classList.remove('hidden');

                const message = `Hola! Reserv√© la Boleta #${ticket.ticketNumber}\n\nN√∫meros: ${ticket.numbers[0]} y ${ticket.numbers[1]}\n\nDatos:\nNombre: ${name}\nCorreo: ${email}\nCelular: ${phone}\nDirecci√≥n: ${address}\nM√©todo: ${payment}\nMonto: $${amount.toLocaleString('es-CO')} de $25.000\n\nComprobante adjunto.`;
                
                setTimeout(() => {
                    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`, '_blank');
                }, 2000);

                setTimeout(() => {
                    document.getElementById('successModal').classList.add('hidden');
                    closeForm();
                }, 5000);
            });
        }

        async function confirmInitialPayment(ticketNumber) {
            if (!confirm(`¬øConfirmar que recibiste el abono inicial de la Boleta #${ticketNumber}?`)) return;
            const key = 'boleta_' + ticketNumber;
            const snap = await get(ref(db, `${RESERVES_PATH}/${key}`));
            if (!snap.exists()) return;
            const t = snap.val();
            t.initialPaymentConfirmed = true;
            t.initialPaymentConfirmedAt = new Date().toISOString();
            await set(ref(db, `${RESERVES_PATH}/${key}`), t);
            alert(`‚úÖ Abono inicial confirmado para Boleta #${ticketNumber}`);
            loadAdminData();
        }

        async function markAsSold(ticketNumber) {
            if (!confirm(`¬øMarcar Boleta #${ticketNumber} como PAGADA COMPLETAMENTE?`)) return;
            const key = 'boleta_' + ticketNumber;
            const snap = await get(ref(db, `${RESERVES_PATH}/${key}`));
            if (!snap.exists()) return;
            const t = snap.val();
            t.status = 'sold';
            t.amountPaid = TICKET_PRICE;
            t.soldAt = new Date().toISOString();
            await set(ref(db, `${RESERVES_PATH}/${key}`), t);
            alert(`‚úÖ Boleta #${ticketNumber} marcada como VENDIDA`);
            loadAdminData();
        }

        async function freeTicketNumber(ticketNumber) {
            if (!confirm(`¬øLiberar la Boleta #${ticketNumber}?`)) return;
            await firebaseRemoveTicket(ticketNumber);
            alert(`üóëÔ∏è Boleta #${ticketNumber} liberada`);
            loadAdminData();
        }

        function openUpdatePayment(ticket) {
            currentUpdateTicket = ticket;
            document.getElementById('updateTicketNum').textContent = ticket.ticketNumber;
            document.getElementById('currentPaid').textContent = ticket.amountPaid.toLocaleString('es-CO');
            document.getElementById('pendingAmount').textContent = (TICKET_PRICE - ticket.amountPaid).toLocaleString('es-CO');
            document.getElementById('newAmountInput').value = ticket.amountPaid;
            document.getElementById('updatePaymentModal').classList.remove('hidden');
        }

        function closeUpdatePayment() {
            document.getElementById('updatePaymentModal').classList.add('hidden');
            currentUpdateTicket = null;
        }

        async function saveUpdatedPayment() {
            if (!currentUpdateTicket) return;
            const newAmount = parseInt(document.getElementById('newAmountInput').value);
            if (isNaN(newAmount) || newAmount < 0 || newAmount > TICKET_PRICE) {
                alert('Monto inv√°lido');
                return;
            }

            const key = 'boleta_' + currentUpdateTicket.ticketNumber;
            const snap = await get(ref(db, `${RESERVES_PATH}/${key}`));
            if (!snap.exists()) return;
            
            const t = snap.val();
            t.amountPaid = newAmount;
            
            // NUEVO: Auto-confirmar abono inicial al actualizar pago
            if (newAmount >= MIN_RESERVATION_PAYMENT && !t.initialPaymentConfirmed) {
                t.initialPaymentConfirmed = true;
                t.initialPaymentConfirmedAt = new Date().toISOString();
            }
            
            // Si complet√≥ el pago, marcar como sold
            if (newAmount >= TICKET_PRICE) {
                t.status = 'sold';
                t.soldAt = new Date().toISOString();
            }
            
            await set(ref(db, `${RESERVES_PATH}/${key}`), t);
            alert(`‚úÖ Pago actualizado a $${newAmount.toLocaleString('es-CO')}`);
            closeUpdatePayment();
            loadAdminData();
        }

        function checkAdminAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('admin') === 'true' || window.location.hash === '#admin') {
                document.getElementById('adminPanel').classList.remove('hidden');
            }
        }

        function toggleAdmin() {
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('hidden');
            if (!panel.classList.contains('hidden') && isAdminLoggedIn) {
                loadAdminData();
            }
        }

        function loginAdmin() {
            const password = document.getElementById('adminPassword').value;
            if (password === ADMIN_PASSWORD) {
                isAdminLoggedIn = true;
                document.getElementById('adminLogin').classList.add('hidden');
                document.getElementById('adminContent').classList.remove('hidden');
                loadAdminData();
            } else {
                alert('‚ùå Contrase√±a incorrecta');
            }
        }

        async function loadAdminData() {
            const snapshot = await get(ref(db, RESERVES_PATH));
            const data = snapshot.val() || {};
            const reservedArr = [];
            const soldArr = [];

            Object.keys(data).forEach(key => {
                const t = data[key];
                if (t.status === 'sold') soldArr.push(t);
                else if (t.status === 'reserved') reservedArr.push(t);
            });

            const reservedList = document.getElementById('reservedList');
            if (reservedArr.length === 0) {
                reservedList.innerHTML = '<p class="text-gray-400">No hay boletas reservadas pendientes</p>';
            } else {
                reservedList.innerHTML = reservedArr.map(ticket => {
                    const reservedTime = ticket.reservedAt ? new Date(ticket.reservedAt) : new Date();
                    const pending = TICKET_PRICE - ticket.amountPaid;
                    const percentPaid = Math.round((ticket.amountPaid / TICKET_PRICE) * 100);
                    
                    // Calcular tiempo restante seg√∫n estado de confirmaci√≥n
                    let timeDisplay = '';
                    let badgeColor = 'bg-yellow-500';
                    
                    if (!ticket.initialPaymentConfirmed) {
                        // Si no confirm√≥ abono inicial: mostrar 24 horas
                        const timeLeft = Math.max(0, 24 - Math.floor((new Date() - reservedTime) / (1000 * 60 * 60)));
                        timeDisplay = `‚è∞ ${timeLeft}h`;
                        badgeColor = timeLeft <= 6 ? 'bg-red-500' : 'bg-yellow-500';
                    } else {
                        // Si confirm√≥ abono: mostrar d√≠as hasta fecha l√≠mite de pago
                        const now = new Date();
                        const daysLeft = Math.ceil((PAYMENT_DEADLINE - now) / (1000 * 60 * 60 * 24));
                        if (daysLeft > 0) {
                            timeDisplay = `üìÖ ${daysLeft} d√≠as`;
                            badgeColor = daysLeft <= 7 ? 'bg-orange-500' : 'bg-blue-500';
                        } else {
                            timeDisplay = '‚ö†Ô∏è Vencido';
                            badgeColor = 'bg-red-600';
                        }
                    }
                    
                    return `
                        <div class="bg-yellow-600/30 border border-yellow-400 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="font-bold text-lg">Boleta #${ticket.ticketNumber}</p>
                                    <p class="text-sm">üìå ${ticket.numbers[0]} y ${ticket.numbers[1]}</p>
                                </div>
                                <span class="${badgeColor} px-2 py-1 rounded text-xs font-bold">${timeDisplay}</span>
                            </div>
                            
                            <div class="bg-white/10 rounded-lg p-3 mb-3">
                                <div class="flex justify-between text-sm mb-1">
                                    <span>Pagado:</span>
                                    <span class="font-bold">${ticket.amountPaid.toLocaleString('es-CO')}</span>
                                </div>
                                <div class="flex justify-between text-sm mb-2">
                                    <span>Pendiente:</span>
                                    <span class="font-bold text-red-300">${pending.toLocaleString('es-CO')}</span>
                                </div>
                                <div class="w-full bg-gray-700 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full" style="width: ${percentPaid}%"></div>
                                </div>
                                <p class="text-xs text-center mt-1">${percentPaid}% pagado</p>
                            </div>
                            
                            <div class="text-sm space-y-1 mb-3">
                                <p>üë§ <strong>Nombre:</strong> ${ticket.buyer?.name || '-'}</p>
                                <p>üìß <strong>Email:</strong> ${ticket.buyer?.email || '-'}</p>
                                <p>üì± <strong>Celular:</strong> ${ticket.buyer?.phone || '-'}</p>
                                <p>üìç <strong>Direcci√≥n:</strong> ${ticket.buyer?.address || '-'}</p>
                                <p>üí≥ <strong>M√©todo:</strong> ${ticket.buyer?.paymentMethod || '-'}</p>
                                <p>üïê <strong>Reservado:</strong> ${reservedTime.toLocaleString('es-CO')}</p>
                            </div>
                            
                            <div class="flex gap-2 mb-2">
                                ${!ticket.initialPaymentConfirmed ? `
                                <button onclick="confirmInitialPayment(${ticket.ticketNumber})" class="flex-1 bg-orange-600 hover:bg-orange-500 py-2 rounded font-semibold text-sm">
                                    üîî Confirmar Abono
                                </button>
                                ` : `
                                <div class="flex-1 bg-green-500/30 border border-green-400 py-2 rounded text-center text-sm">
                                    ‚úÖ Abono Confirmado
                                </div>
                                `}
                            </div>
                            <div class="flex gap-2">
                                <button onclick="openUpdatePayment(${JSON.stringify(ticket).replace(/"/g, '&quot;')})" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded font-semibold">
                                    üí∞ Actualizar Pago
                                </button>
                                <button onclick="markAsSold(${ticket.ticketNumber})" class="flex-1 bg-green-600 hover:bg-green-500 py-2 rounded font-semibold">
                                    ‚úÖ Completada
                                </button>
                                <button onclick="freeTicketNumber(${ticket.ticketNumber})" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded font-semibold">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            const soldList = document.getElementById('soldList');
            if (soldArr.length === 0) {
                soldList.innerHTML = '<p class="text-gray-400">No hay boletas pagadas completamente</p>';
            } else {
                soldList.innerHTML = soldArr.map(ticket => `
                    <div class="bg-green-600/30 border border-green-400 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-lg">Boleta #${ticket.ticketNumber}</p>
                                <p class="text-sm">${ticket.numbers[0]} y ${ticket.numbers[1]}</p>
                                <div class="text-sm mt-2 space-y-1">
                                    <p>üë§ ${ticket.buyer?.name || '-'}</p>
                                    <p>üìß ${ticket.buyer?.email || '-'}</p>
                                    <p>üì± ${ticket.buyer?.phone || '-'}</p>
                                    <p>üìç ${ticket.buyer?.address || '-'}</p>
                                    <p class="font-bold text-green-300">üíµ PAGADO: $25.000</p>
                                </div>
                            </div>
                            <span class="bg-green-500 px-3 py-1 rounded text-xs font-bold">‚úÖ PAGADA</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function freeTicket() {
            const ticketNum = parseInt(document.getElementById('ticketToFree').value);
            if (ticketNum >= 1 && ticketNum <= TOTAL_TICKETS) {
                await firebaseRemoveTicket(ticketNum);
                document.getElementById('ticketToFree').value = '';
                alert(`üóëÔ∏è Boleta #${ticketNum} liberada`);
                loadAdminData();
            } else {
                alert('‚ùå N√∫mero inv√°lido');
            }
        }

        function showTerms() {
            document.getElementById('termsModal').classList.remove('hidden');
        }

        function closeTerms() {
            document.getElementById('termsModal').classList.add('hidden');
        }

        async function cleanupExpiredReservations() {
            const snap = await get(ref(db, RESERVES_PATH));
            const data = snap.val() || {};
            const now = Date.now();
            for (const key of Object.keys(data)) {
                const t = data[key];
                if (t.status === 'reserved' && t.reservedAt && !t.initialPaymentConfirmed) {
                    // Solo liberar si no confirm√≥ el abono inicial en 24 horas
                    const reservedAt = new Date(t.reservedAt).getTime();
                    const hoursPassed = (now - reservedAt) / (1000 * 60 * 60);
                    if (hoursPassed >= 24) {
                        await remove(ref(db, `${RESERVES_PATH}/${key}`));
                    }
                }
                // Nota: No liberamos autom√°ticamente despu√©s de la fecha l√≠mite de pago,
                // el admin debe gestionar eso manualmente
            }
        }

        function updateCountdown() {
            const now = new Date();
            const diff = DRAW_DATE - now;
            if (diff <= 0) {
                document.getElementById('countdown').textContent = '¬°Sorteo finalizado!';
                return;
            }
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            document.getElementById('countdown').textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }

        document.getElementById('footerWhatsapp').textContent = `+57 ${WHATSAPP_NUMBER.slice(2)}`;
        document.getElementById('whatsappDisplay').textContent = `+57 ${WHATSAPP_NUMBER.slice(2)}`;

        const paymentSelect = document.getElementById('inputPayment');
        const paymentInfo = document.getElementById('paymentInfo');
        const paymentDetails = document.getElementById('paymentDetails');

        paymentSelect.addEventListener('change', () => {
            const val = paymentSelect.value;
            if (!val) {
                paymentInfo.classList.add('hidden');
                return;
            }
            paymentDetails.textContent = paymentAccounts[val] || '';
            paymentInfo.classList.remove('hidden');
        });

        buildInitialTickets();
        renderTickets();
        updateCountdown();
        setInterval(updateCountdown, 1000);
        setInterval(cleanupExpiredReservations, 1000 * 60 * 60);
        checkAdminAccess();

        window.openForm = openForm;
        window.closeForm = closeForm;
        window.submitReservation = submitReservation;
        window.toggleAdmin = toggleAdmin;
        window.loginAdmin = loginAdmin;
        window.freeTicketNumber = freeTicketNumber;
        window.markAsSold = markAsSold;
        window.freeTicket = freeTicket;
        window.loadAdminData = loadAdminData;
        window.showTerms = showTerms;
        window.closeTerms = closeTerms;
        window.openUpdatePayment = openUpdatePayment;
        window.closeUpdatePayment = closeUpdatePayment;
        window.saveUpdatedPayment = saveUpdatedPayment;
        window.confirmInitialPayment = confirmInitialPayment;
    </script>
</body>
</html>