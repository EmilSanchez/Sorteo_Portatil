<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rifa Universitaria - Portátil Gamer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce { animation: bounce 1s infinite; }
        
        body {
            background: linear-gradient(135deg, #2a0168 0%, #182f6e 50%, #222058 100%);
            min-height: 100vh;
        }
        
        .ticket-card {
            width: 100%;
            transition: all 0.3s ease;
        }
        
        .ticket-card:hover:not(:disabled) {
            transform: scale(1.05);
        }
    </style>
</head>
<body class="text-white">
    <!-- Header -->
    <div class="bg-black/30 backdrop-blur-md shadow-xl">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="text-center">
                <h1 class="text-4xl font-bold mb-2 flex items-center justify-center gap-3">
                    Sorteo con el fin de recoger fondos Universitarios
                </h1>
                <p class="text-xl text-yellow-300 font-semibold mb-4">
                    Premio: ASUS TUF Gaming Ryzen 7 / RTX 3050 / 16GB RAM DDR5 / 500GB M.2
                </p>
                <p class="text-2xl font-bold text-green-400">
                    o $3.000.000 COP en efectivo (a elección del ganador)
                </p>
                
                <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 max-w-3xl mx-auto">
                    <div class="bg-white/10 rounded-lg p-4">
                        <p class="text-sm text-gray-300">Valor boleta</p>
                        <p class="text-2xl font-bold">$20.000</p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <p class="text-sm text-gray-300">Total boletas</p>
                        <p class="text-2xl font-bold">500</p>
                        <p class="text-xs text-gray-400 mt-1">2 números por boleta</p>
                    </div>
                    <div class="bg-white/10 rounded-lg p-4">
                        <p class="text-sm text-gray-300">Sorteo</p>
                        <p class="text-lg font-bold">6 de diciembre 2025</p>
                        <p class="text-xs text-gray-300">Lotería de Santander</p>
                    </div>
                </div>

                <div class="mt-6 bg-red-600/20 border-2 border-red-400 rounded-lg p-4 max-w-md mx-auto">
                    <div class="flex items-center justify-center gap-2 mb-2">
                         <p class="text-sm font-semibold">Tiempo restante para el sorteo</p>
                    </div>
                    <p id="countdown" class="text-3xl font-mono font-bold">Calculando...</p>
                </div>

                <div class="mt-4 bg-blue-500/20 border border-blue-400 rounded-lg p-3 max-w-2xl mx-auto">
                    <p class="text-sm">
                         <strong>¡Doble oportunidad!</strong> Cada boleta incluye 2 números (000-499 y 500-999)
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="grid grid-cols-3 gap-4 mb-6">
            <div class="bg-green-600/20 border border-green-400 rounded-lg p-4 text-center">
                <p id="availableCount" class="text-3xl font-bold">500</p>
                <p class="text-sm">Disponibles</p>
            </div>
            <div class="bg-yellow-600/20 border border-yellow-400 rounded-lg p-4 text-center">
                <p id="reservedCount" class="text-3xl font-bold">0</p>
                <p class="text-sm">Reservadas</p>
            </div>
            <div class="bg-red-600/20 border border-red-400 rounded-lg p-4 text-center">
                <p id="soldCount" class="text-3xl font-bold">0</p>
                <p class="text-sm">Vendidas</p>
            </div>
        </div>

        <!-- Grilla de boletas -->
        <div class="bg-white/10 backdrop-blur-md rounded-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
                🎫 Selecciona tu boleta
            </h2>
            <div id="ticketsGrid" class="grid grid-cols-1 sm:grid-cols-6 lg:grid-cols-3 xl:grid-cols-6 gap-3 style=color: "black;">
                <!-- Las boletas se generarán con JavaScript -->
            </div>
        </div>

        <button onclick="showTerms()" class="w-full bg-white/10 hover:bg-white/20 rounded-lg p-4 mb-6 transition-all">
            📋 Ver Términos y Condiciones
        </button>
    </div>

    <!-- Modal Formulario -->
    <div id="formModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="bg-gradient-to-br from-purple-800 to-blue-800 rounded-xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-2">
                Reservar Boleta #<span id="selectedTicketNum"></span>
            </h3>
            <p class="text-yellow-300 mb-4 text-sm">
                📌 Números: <strong><span id="selectedNumbers"></span></strong>
            </p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold mb-2">Nombre completo</label>
                    <input type="text" id="inputName" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Correo electrónico</label>
                    <input type="email" id="inputEmail" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Celular</label>
                    <input type="tel" id="inputPhone" placeholder="3103535483" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                </div>

                <div>
                    <label class="block text-sm font-semibold mb-2">Método de pago</label>
                    <select id="inputPayment" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                        <option value="" style="color: #000;">Seleccionar...</option>
                        <option value="Nequi" style="color: #000;">Nequi</option>
                        <option value="Llaves" style="color: #000;">Llaves</option>
                        <option value="Efectivo" style="color: #000;">Efectivo</option>
                        <option value="Otro" style="color: #000;">Otro</option>
                    </select>

                    <!-- Información dinámica según método de pago -->
                    <div id="paymentInfo" class="mt-3 text-sm bg-white/10 rounded-lg p-3 hidden">
                        <div class="font-semibold mb-1">Instrucciones de pago</div>
                        <div id="paymentDetails" class="font-mono"></div>
                    </div>
                </div>

                <script>
                    // Mapea cada opción a las instrucciones / número de cuenta que quieres mostrar
                    const paymentAccounts = {
                        Nequi: 'Nequi: 3167862046 (A nombre de Maria Martinez). Enviar comprobante por WhatsApp.',
                        Llaves: 'Llaves: 3167862046 (A nombre de Maria Martinez). Indica que es consignación por la rifa.',
                        Efectivo: 'Efectivo: Pagar en punto de encuentro. Coordinar lugar y hora por WhatsApp.',
                        Otro: 'Otro: Por favor describe el método en el mensaje de WhatsApp y sube el comprobante.'
                    };

                    const paymentSelect = document.getElementById('inputPayment');
                    const paymentInfo = document.getElementById('paymentInfo');
                    const paymentDetails = document.getElementById('paymentDetails');

                    function updatePaymentInfo() {
                        const val = paymentSelect.value;
                        if (!val) {
                            paymentInfo.classList.add('hidden');
                            paymentDetails.textContent = '';
                            return;
                        }
                        paymentDetails.textContent = paymentAccounts[val] || '';
                        paymentInfo.classList.remove('hidden');
                    }

                    paymentSelect.addEventListener('change', updatePaymentInfo);

                    // Si el modal se cierra y se limpia el select, ocultamos también el recuadro
                    // (esto cubre el caso de closeForm que pone inputPayment.value = '')
                    const observer = new MutationObserver(() => {
                        if (paymentSelect.value === '') updatePaymentInfo();
                    });
                    observer.observe(paymentSelect, { attributes: true, attributeFilter: ['value'] });

                    // Inicializa el estado si ya hay un valor seleccionado al abrir el modal
                    updatePaymentInfo();
                </script>

                <div class="bg-yellow-400/20 border border-yellow-400 rounded-lg p-4">
                    <label class="flex items-start gap-3 cursor-pointer">
                        <input type="checkbox" id="inputTerms" class="mt-1 w-5 h-5">
                        <span class="text-sm">
                            Acepto los términos y condiciones. Entiendo que tengo 24 horas para enviar el comprobante de pago y que el ganador puede elegir entre el portátil o $3.000.000 COP en efectivo.
                        </span>
                    </label>
                </div>

                <div class="flex gap-3">
                    <button onclick="closeForm()" class="flex-1 bg-gray-600 hover:bg-gray-500 py-3 rounded-lg font-semibold transition-all">
                        Cancelar
                    </button>
                    <button onclick="submitReservation()" class="flex-1 bg-green-600 hover:bg-green-500 py-3 rounded-lg font-semibold transition-all">
                        Reservar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Términos -->
    <div id="termsModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="bg-white text-gray-900 rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h3 class="text-2xl font-bold mb-4">Términos y Condiciones</h3>
            
            <div class="space-y-4 text-sm">
                <section>
                    <h4 class="font-bold text-lg mb-2">1. Del Premio</h4>
                    <p>El ganador podrá elegir entre:</p>
                    <ul class="list-disc ml-6 mt-2">
                        <li>Portátil ASUS TUF Gaming Ryzen 7 / RTX 3050 / 16GB RAM DDR5 / 500GB M.2</li>
                        <li>$3.000.000 COP en efectivo</li>
                    </ul>
                    <p class="mt-2">La elección debe realizarse en un plazo máximo de 24 horas después del sorteo.</p>
                </section>

                <section>
                    <h4 class="font-bold text-lg mb-2">2. De las Boletas</h4>
                    <p>Cada boleta incluye 2 números automáticamente asignados:</p>
                    <ul class="list-disc ml-6 mt-2">
                        <li>Boleta #1 incluye números 000 y 500</li>
                        <li>Boleta #2 incluye números 001 y 501</li>
                        <li>Y así sucesivamente hasta la Boleta #500 con números 499 y 999</li>
                    </ul>
                    <p class="mt-2">Esto significa que con una sola boleta participas con dos números en el sorteo, duplicando tus oportunidades de ganar.</p>
                </section>

                <section>
                    <h4 class="font-bold text-lg mb-2">3. De la Reserva</h4>
                    <p>Al reservar una boleta, el comprador tiene 24 horas para enviar el comprobante de pago al WhatsApp indicado. Si no se recibe el comprobante en ese plazo, la reserva será liberada automáticamente.</p>
                </section>

                <section>
                    <h4 class="font-bold text-lg mb-2">4. Del Sorteo</h4>
                    <p>El sorteo se realizará el 6 de diciembre de 2025, siguiendo los resultados de la Lotería de Santander. El número ganador corresponderá a las últimas 3 cifras del premio mayor.</p>
                </section>

                <section>
                    <h4 class="font-bold text-lg mb-2">5. De la Entrega</h4>
                    <p>El premio será entregado dentro de los 5 días hábiles siguientes al sorteo, previa validación del boleto ganador y presentación de documento de identidad.</p>
                </section>

                <section>
                    <h4 class="font-bold text-lg mb-2">6. Responsabilidad</h4>
                    <p>Los organizadores no se hacen responsables por información errónea proporcionada por el participante. Es responsabilidad del comprador conservar su comprobante de pago.</p>
                </section>

                <section>
                    <h4 class="font-bold text-lg mb-2">7. Validez</h4>
                    <p>Solo participan boletas debidamente pagadas y confirmadas por los organizadores antes de la fecha del sorteo.</p>
                </section>
            </div>

            <button onclick="closeTerms()" class="w-full mt-6 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-semibold transition-all">
                Cerrar
            </button>
        </div>
    </div>

    <!-- Modal Éxito -->
    <div id="successModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="bg-green-600 rounded-xl p-8 max-w-md w-full text-center">
            <div class="text-6xl mb-4 animate-bounce">✅</div>
            <h3 class="text-2xl font-bold mb-4">Reserva Registrada</h3>
            <div class="bg-white/20 rounded-lg p-3 mb-4">
                <p class="font-bold">Boleta #<span id="successTicketNum"></span></p>
                <p class="text-sm">Números: <span id="successNumbers"></span></p>
            </div>
            <p class="mb-4">
                Envía tu comprobante al WhatsApp <strong id="whatsappDisplay"></strong> para validar tu participación.
            </p>
            <p class="text-sm bg-white/20 rounded-lg p-3">
                Tienes 24 horas para enviar el comprobante; si no se recibe, la reserva será liberada.
            </p>
        </div>
    </div>

    <!-- Modal Éxito -->
    <div id="successModal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50">
        <div class="bg-green-600 rounded-xl p-8 max-w-md w-full text-center">
        </div>    <div class="text-6xl mb-4 animate-bounce">✅</div>
            <h3 class="text-2xl font-bold mb-4">Reserva Registrada</h3>
            <div class="bg-white/20 rounded-lg p-3 mb-4">
                <p class="font-bold">Boleta #<span id="successTicketNum"></span></p>
                <p class="text-sm">Números: <span id="successNumbers"></span></p>
            </div>
            <p class="mb-4">
                Envía tu comprobante al WhatsApp <strong id="whatsappDisplay"></strong> para validar tu participación.
            </p>
            <p class="text-sm bg-white/20 rounded-lg p-3">
                Tienes 24 horas para enviar el comprobante; si no se recibe, la reserva será liberada.
            </p>
        </div>
    </div>

    <!-- Panel Admin -->
    <div id="adminPanel" class="hidden fixed inset-0 bg-black/90 z-50 overflow-y-auto">
        <div class="max-w-6xl mx-auto p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-white">🔑 Panel de Administración</h2>
                <button onclick="toggleAdmin()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg">
                    Cerrar
                </button>
            </div>

            <!-- Contraseña Admin -->
            <div id="adminLogin" class="bg-white/10 backdrop-blur-md rounded-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-4">Ingresa la contraseña de administrador</h3>
                <div class="flex gap-3">
                    <input type="password" id="adminPassword" placeholder="Contraseña" class="flex-1 px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                    <button onclick="loginAdmin()" class="bg-green-600 hover:bg-green-500 px-6 py-2 rounded-lg font-semibold">
                        Entrar
                    </button>
                </div>
                <p class="text-sm text-gray-400 mt-2"><code></code></p>
            </div>

            <!-- Lista de Reservas -->
            <div id="adminContent" class="hidden">
                <div class="bg-white/10 backdrop-blur-md rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">📋 Boletas Reservadas (Pendientes de Pago)</h3>
                    <div id="reservedList" class="space-y-3">
                        <!-- Se llenará con JavaScript -->
                    </div>
                </div>

                <div class="bg-white/10 backdrop-blur-md rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4 text-green-400">✅ Boletas Vendidas (Pagadas)</h3>
                    <div id="soldList" class="space-y-3">
                        <!-- Se llenará con JavaScript -->
                    </div>
                </div>

                <div class="bg-white/10 backdrop-blur-md rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">🗑️ Liberar Boleta Manualmente</h3>
                    <div class="flex gap-3">
                        <input type="number" id="ticketToFree" placeholder="Número de boleta" min="1" max="500" class="flex-1 px-4 py-2 rounded-lg bg-white/20 border border-white/30 focus:border-yellow-400 focus:outline-none text-white">
                        <button onclick="freeTicket()" class="bg-red-600 hover:bg-red-500 px-6 py-2 rounded-lg font-semibold">
                            Liberar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="max-w-7xl mx-auto px-4 py-6 text-center text-sm text-gray-400">
        <p>Rifa Universitaria 2025 • Todas las transacciones deben ser validadas</p>
        <p class="mt-2">WhatsApp: <span id="footerWhatsapp"></span></p>
    </div>

    <script type="module">
        /* ---------------------------
        INTEGRACIÓN FIREBASE + LÓGICA DE RAFIA
        Reemplaza TU script actual por este
        - Sincroniza reservas en tiempo real
        - Guarda: buyer, payment, reservedAt, status, amountPaid
        - Pago mínimo para reservar: 5000 COP
        - Admin puede marcar como 'sold' o 'available'
        ----------------------------*/

        /* ---------- CONFIG - CAMBIA SI ES NECESARIO ---------- */
        const WHATSAPP_NUMBER = '573151371553'; // tu número
        const DRAW_DATE = new Date('2025-12-06T20:00:00'); // fecha sorteo
        const TICKET_PRICE = 20000;
        const TOTAL_TICKETS = 500;
        const ADMIN_PASSWORD = '210621#'; // cambia si quieres
        const MIN_RESERVATION_PAYMENT = 5000; // monto mínimo para apartar

        /* ---------- IMPORTS FIREBASE (CDN ESM) ---------- */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get, remove } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

        /* ---------- TU firebaseConfig (pega el tuyo exacto) ---------- */
        const firebaseConfig = {
        apiKey: "AIzaSyBOuEPesCNGxWxKxcJuPbGnNHJArBuj7Nc",
        authDomain: "rifa-universitaria-657c8.firebaseapp.com",
        databaseURL: "https://rifa-universitaria-657c8-default-rtdb.firebaseio.com",
        projectId: "rifa-universitaria-657c8",
        storageBucket: "rifa-universitaria-657c8.firebasestorage.app",
        messagingSenderId: "173786953583",
        appId: "1:173786953583:web:7275693fc0948a65b35a9a",
        measurementId: "G-H97SMY9BK5"
        };

        /* ---------- INICIALIZACIÓN ---------- */
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const RESERVES_PATH = 'rifa/reservas'; // nodo donde guardaremos reservas

        /* ---------- ESTADO LOCAL (se sincroniza desde Firebase) ---------- */
        let tickets = []; // array de 500 boletas { ticketNumber, numbers:[a,b], status, buyer, reservedAt, amountPaid }
        let selectedTicket = null;
        let isAdminLoggedIn = false;

        /* ---------- Inicializar tickets (estructura local; re-render se hace al recibir datos) ---------- */
        function buildInitialTickets() {
        tickets = [];
        for (let i = 0; i < TOTAL_TICKETS; i++) {
            const ticketNum = i + 1;
            const firstNumber = String(i).padStart(3, '0');
            const secondNumber = String(999 - i).padStart(3, '0');
            tickets.push({
            ticketNumber: ticketNum,
            numbers: [firstNumber, secondNumber],
            status: 'available', // available | reserved | sold
            buyer: null,
            reservedAt: null,
            amountPaid: 0
            });
        }
        }

        /* ---------- RENDER UI ---------- */
        function renderTickets() {
        const grid = document.getElementById('ticketsGrid');
        grid.innerHTML = '';
        tickets.forEach(ticket => {
            const button = document.createElement('button');
            button.className = `ticket-card rounded-lg p-4 font-bold transition-all text-left ${
            ticket.status === 'available' 
                ? 'bg-green-500 hover:bg-blue-400 cursor-pointer shadow-lg' 
                : ticket.status === 'reserved'
                ? 'bg-yellow-600 cursor-not-allowed opacity-60'
                : 'bg-red-600 cursor-not-allowed opacity-60'
            }`;
            button.disabled = ticket.status !== 'available';
            button.onclick = () => openForm(ticket);
            button.innerHTML = `
            <div class="text-lg mb-1">Boleta #${ticket.ticketNumber}</div>
            <div class="text-sm font-normal opacity-90">${ticket.numbers[0]} y ${ticket.numbers[1]}</div>
            `;
            grid.appendChild(button);
        });
        updateStats();
        }

        /* ---------- STATS ---------- */
        function updateStats() {
        const available = tickets.filter(t => t.status === 'available').length;
        const reserved = tickets.filter(t => t.status === 'reserved').length;
        const sold = tickets.filter(t => t.status === 'sold').length;
        document.getElementById('availableCount').textContent = available;
        document.getElementById('reservedCount').textContent = reserved;
        document.getElementById('soldCount').textContent = sold;
        }

        /* ---------- MODALES ---------- */
        function openForm(ticket) {
        selectedTicket = ticket;
        document.getElementById('selectedTicketNum').textContent = ticket.ticketNumber;
        document.getElementById('selectedNumbers').textContent = `${ticket.numbers[0]} y ${ticket.numbers[1]}`;
        document.getElementById('formModal').classList.remove('hidden');
        }
        function closeForm() {
        document.getElementById('formModal').classList.add('hidden');
        selectedTicket = null;
        document.getElementById('inputName').value = '';
        document.getElementById('inputEmail').value = '';
        document.getElementById('inputPhone').value = '';
        document.getElementById('inputPayment').value = '';
        document.getElementById('inputTerms').checked = false;
        }

        /* ---------- FUNCIONES FIREBASE ---------- */
        /* Guarda/actualiza reserva para una BOLETA (no por número de 000..999)
        Key en DB -> rif a/reservas/boleta_<ticketNumber>
        Contenido: { ticketNumber, numbers:[a,b], status, buyer, reservedAt, amountPaid }
        */
        async function firebaseSaveTicket(ticket) {
        const key = 'boleta_' + ticket.ticketNumber;
        await set(ref(db, `${RESERVES_PATH}/${key}`), ticket);
        }

        /* Eliminar registro (liberar) */
        async function firebaseRemoveTicket(ticketNumber) {
        const key = 'boleta_' + ticketNumber;
        await remove(ref(db, `${RESERVES_PATH}/${key}`));
        }

        /* Escuchar cambios en tiempo real y actualizar "tickets" local */
        onValue(ref(db, RESERVES_PATH), (snapshot) => {
        const data = snapshot.val() || {};
        // rebuild tickets base then merge DB
        buildInitialTickets();
        // recorrer cada entrada de DB y mapear al local
        Object.keys(data).forEach(key => {
            const t = data[key];
            // key expected boleta_#
            const match = key.match(/^boleta_(\d+)$/);
            if (!match) return;
            const ticketNumber = parseInt(match[1], 10);
            const idx = tickets.findIndex(x => x.ticketNumber === ticketNumber);
            if (idx !== -1) {
            // merge
            tickets[idx] = {
                ticketNumber: ticketNumber,
                numbers: t.numbers || tickets[idx].numbers,
                status: t.status || tickets[idx].status,
                buyer: t.buyer || null,
                reservedAt: t.reservedAt || null,
                amountPaid: t.amountPaid || 0
            };
            }
        });
        renderTickets();
        });

        /* ---------- RESERVA: validación de pago mínimo y guardado ---------- */
        function submitReservation() {
        const name = document.getElementById('inputName').value.trim();
        const email = document.getElementById('inputEmail').value.trim();
        const phone = document.getElementById('inputPhone').value.trim();
        const payment = document.getElementById('inputPayment').value;
        const terms = document.getElementById('inputTerms').checked;

        if (!name || !email || !phone || !payment) {
            alert('Por favor completa todos los campos');
            return;
        }
        if (!terms) {
            alert('Debes aceptar los términos y condiciones');
            return;
        }
        if (!selectedTicket) {
            alert('No hay boleta seleccionada');
            return;
        }

        // Pedimos al comprador que confirme cuánto pagó (mínimo 5000)
        const amountStr = prompt(`Ingresa el monto que pagarás para apartar la boleta (mínimo ${MIN_RESERVATION_PAYMENT.toLocaleString('es-CO')} COP):`, `${MIN_RESERVATION_PAYMENT}`);
        const amount = parseInt(amountStr, 10);
        if (isNaN(amount) || amount < MIN_RESERVATION_PAYMENT) {
            alert(`El monto mínimo para apartar es ${MIN_RESERVATION_PAYMENT.toLocaleString('es-CO')} COP`);
            return;
        }

        // Preparar objeto de reserva
        const ticketIndex = tickets.findIndex(t => t.ticketNumber === selectedTicket.ticketNumber);
        const ticket = tickets[ticketIndex];
        ticket.status = 'reserved';
        ticket.buyer = { name, email, phone, paymentMethod: payment };
        ticket.reservedAt = new Date().toISOString();
        ticket.amountPaid = amount;

        // Guardar en Firebase (esto propagará el cambio a todos los clientes)
        firebaseSaveTicket(ticket).then(() => {
            // Mostrar modal de éxito y abrir WhatsApp
            document.getElementById('successTicketNum').textContent = ticket.ticketNumber;
            document.getElementById('successNumbers').textContent = `${ticket.numbers[0]} y ${ticket.numbers[1]}`;
            document.getElementById('successModal').classList.remove('hidden');

            // mensaje prellenado
            const message = `Hola Emil! Reservé la Boleta #${ticket.ticketNumber} de la rifa del portátil gamer.\n\n📌 Números: ${ticket.numbers[0]} y ${ticket.numbers[1]}\n\nDatos:\nNombre: ${name}\nCorreo: ${email}\nCelular: ${phone}\nMétodo de pago: ${payment}\nMonto pagado: ${amount.toLocaleString('es-CO')} COP\n\nEnvío mi comprobante de pago.`;

            const encoded = encodeURIComponent(message);
            const isMobile = /Android|iPhone|iPad|iPod|Windows Phone|Opera Mini|IEMobile/i.test(navigator.userAgent);
            if (isMobile) {
            window.location.href = `whatsapp://send?phone=${WHATSAPP_NUMBER}&text=${encoded}`;
            setTimeout(() => {
                window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encoded}`, '_blank');
            }, 700);
            } else {
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encoded}`, '_blank');
            }

            // cerrar y refrescar UI local (la onValue de Firebase hará el re-render globalmente)
            setTimeout(() => {
            document.getElementById('successModal').classList.add('hidden');
            closeForm();
            }, 4000);
        }).catch(err => {
            console.error('Error guardando reserva en Firebase:', err);
            alert('Ocurrió un error al guardar la reserva. Intenta de nuevo.');
        });
        }

        /* ---------- ADMIN: funciones para cambiar estado en Firebase ---------- */
        async function markAsSold(ticketNumber) {
        if (!confirm(`¿Confirmas que recibiste el pago de la Boleta #${ticketNumber}?`)) return;
        const key = 'boleta_' + ticketNumber;
        const ticketRef = ref(db, `${RESERVES_PATH}/${key}`);
        // obtener el registro actual
        const snap = await get(ticketRef);
        if (!snap.exists()) {
            alert('No existe la reserva en la base de datos.');
            return;
        }
        const t = snap.val();
        t.status = 'sold';
        t.soldAt = new Date().toISOString();
        await set(ticketRef, t);
        alert(`✅ Boleta #${ticketNumber} marcada como VENDIDA`);
        }

        async function freeTicketNumber(ticketNumber) {
        if (!confirm(`¿Liberar la Boleta #${ticketNumber}? Quedará disponible nuevamente.`)) return;
        const key = 'boleta_' + ticketNumber;
        // simplemente remover la entrada en DB para que vuelva a estado "available" localmente
        await remove(ref(db, `${RESERVES_PATH}/${key}`));
        alert(`🗑️ Boleta #${ticketNumber} liberada`);
        }

        /* ---------- Panel admin: manejo de UI ---------- */
        function checkAdminAccess() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('admin') === 'true' || window.location.hash === '#admin') {
            document.getElementById('adminPanel').classList.remove('hidden');
        }
        }
        function toggleAdmin() {
        const panel = document.getElementById('adminPanel');
        panel.classList.toggle('hidden');
        if (!panel.classList.contains('hidden') && isAdminLoggedIn) {
            loadAdminData();
        }
        }
        function loginAdmin() {
        const password = document.getElementById('adminPassword').value;
        if (password === ADMIN_PASSWORD) {
            isAdminLoggedIn = true;
            document.getElementById('adminLogin').classList.add('hidden');
            document.getElementById('adminContent').classList.remove('hidden');
            loadAdminData();
        } else {
            alert('❌ Contraseña incorrecta');
        }
        }
        async function loadAdminData() {
        // Leer todas las reservas desde Firebase
        const snapshot = await get(ref(db, RESERVES_PATH));
        const data = snapshot.val() || {};
        const reservedArr = [];
        const soldArr = [];
        Object.keys(data).forEach(key => {
            const t = data[key];
            if (t.status === 'sold') soldArr.push(t);
            else if (t.status === 'reserved') reservedArr.push(t);
        });

        const reservedList = document.getElementById('reservedList');
        if (reservedArr.length === 0) {
            reservedList.innerHTML = '<p class="text-gray-400">No hay boletas reservadas pendientes</p>';
        } else {
            reservedList.innerHTML = reservedArr.map(ticket => {
            const reservedTime = ticket.reservedAt ? new Date(ticket.reservedAt) : new Date();
            const timeLeft = Math.max(0, 24 - Math.floor((new Date() - reservedTime) / (1000 * 60 * 60)));
            return `
                <div class="bg-yellow-600/30 border border-yellow-400 rounded-lg p-4">
                <div class="flex justify-between items-start mb-2">
                    <div>
                    <p class="font-bold text-lg">Boleta #${ticket.ticketNumber}</p>
                    <p class="text-sm">📌 Números: ${ticket.numbers[0]} y ${ticket.numbers[1]}</p>
                    </div>
                    <span class="bg-yellow-500 px-2 py-1 rounded text-xs font-bold">⏰ ${timeLeft}h</span>
                </div>
                <div class="text-sm space-y-1 mb-3">
                    <p>👤 <strong>Nombre:</strong> ${ticket.buyer?.name || '-'}</p>
                    <p>📧 <strong>Email:</strong> ${ticket.buyer?.email || '-'}</p>
                    <p>📱 <strong>Celular:</strong> ${ticket.buyer?.phone || '-'}</p>
                    <p>💳 <strong>Pago:</strong> ${ticket.buyer?.paymentMethod || '-'}</p>
                    <p>💵 <strong>Monto pagado:</strong> ${ticket.amountPaid ? ticket.amountPaid.toLocaleString('es-CO') : '0'}</p>
                    <p>🕐 <strong>Reservado:</strong> ${ticket.reservedAt ? new Date(ticket.reservedAt).toLocaleString('es-CO') : '-'}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="markAsSold(${ticket.ticketNumber})" class="flex-1 bg-green-600 hover:bg-green-500 py-2 rounded font-semibold">✅ Marcar como PAGADA</button>
                    <button onclick="freeTicketNumber(${ticket.ticketNumber})" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded font-semibold">🗑️</button>
                </div>
                </div>
            `;
            }).join('');
        }

        const soldList = document.getElementById('soldList');
        if (soldArr.length === 0) {
            soldList.innerHTML = '<p class="text-gray-400">No hay boletas vendidas aún</p>';
        } else {
            soldList.innerHTML = soldArr.map(ticket => `
            <div class="bg-green-600/30 border border-green-400 rounded-lg p-4">
                <div class="flex justify-between items-start">
                <div>
                    <p class="font-bold text-lg">Boleta #${ticket.ticketNumber}</p>
                    <p class="text-sm">📌 Números: ${ticket.numbers[0]} y ${ticket.numbers[1]}</p>
                    <div class="text-sm mt-2 space-y-1">
                    <p>👤 ${ticket.buyer?.name || '-'}</p>
                    <p>📧 ${ticket.buyer?.email || '-'}</p>
                    <p>📱 ${ticket.buyer?.phone || '-'}</p>
                    </div>
                </div>
                <span class="bg-green-500 px-3 py-1 rounded text-xs font-bold">✅ PAGADA</span>
                </div>
            </div>
            `).join('');
        }
        }

        /* ---------- UTIL: liberar boleta manual ---------- */
        async function freeTicket() {
        const ticketNum = parseInt(document.getElementById('ticketToFree').value);
        if (ticketNum >= 1 && ticketNum <= TOTAL_TICKETS) {
            await firebaseRemoveTicket(ticketNum);
            document.getElementById('ticketToFree').value = '';
            loadAdminData();
        } else {
            alert('❌ Número de boleta inválido (debe ser entre 1 y 500)');
        }
        }

        /* ---------- EXPIRACIÓN: liberar reservas si pasan 24h ---------- */
        async function cleanupExpiredReservations() {
        const snap = await get(ref(db, RESERVES_PATH));
        const data = snap.val() || {};
        const now = Date.now();
        for (const key of Object.keys(data)) {
            const t = data[key];
            if (t.status === 'reserved' && t.reservedAt) {
            const reservedAt = new Date(t.reservedAt).getTime();
            const hoursPassed = (now - reservedAt) / (1000 * 60 * 60);
            if (hoursPassed >= 24) {
                // eliminar para liberar
                await remove(ref(db, `${RESERVES_PATH}/${key}`));
            }
            }
        }
        }

        /* ---------- Contador y helper UI ---------- */
        function updateCountdown() {
        const now = new Date();
        const diff = DRAW_DATE - now;
        if (diff <= 0) {
            document.getElementById('countdown').textContent = '¡Sorteo finalizado!';
            return;
        }
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        document.getElementById('countdown').textContent = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }

        /* ---------- Mostrar datos de footer ---------- */
        document.getElementById('footerWhatsapp').textContent = `+57 ${WHATSAPP_NUMBER.slice(2)}`;
        document.getElementById('whatsappDisplay').textContent = `+57 ${WHATSAPP_NUMBER.slice(2)}`;

        /* ---------- INICIALIZACIÓN FINAL ---------- */
        buildInitialTickets(); // crea estructura base
        renderTickets();       // dibuja inicialmente (será sobreescrita por onValue)
        updateCountdown();
        setInterval(updateCountdown, 1000);
        setInterval(() => {
        // limpieza periódica (cada hora)
        cleanupExpiredReservations().catch(console.error);
        }, 1000 * 60 * 60);

        checkAdminAccess(); // abre panel si ?admin=true
        // Exponer funciones al scope global para que botones onClick en HTML las llamen:
        window.openForm = openForm;
        window.closeForm = closeForm;
        window.submitReservation = submitReservation;
        window.toggleAdmin = toggleAdmin;
        window.loginAdmin = loginAdmin;
        window.freeTicketNumber = freeTicketNumber;
        window.markAsSold = markAsSold;
        window.freeTicket = freeTicket;
        window.loadAdminData = loadAdminData;

    </script>
</body>
</html>