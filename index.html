<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bendiciones Universitaria</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>


        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); box-shadow: 0 0 20px rgba(37, 211, 102, 0.8); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce { animation: bounce 1s infinite; }
        body {
            background: linear-gradient(135deg, #2a0168 0%, #182f6e 50%, #222058 100%);
            min-height: 100vh;
        }
        .ticket-card { transition: all 0.3s ease; }
        .ticket-card:hover:not(:disabled) { transform: scale(1.05); }
    </style>
    
</head>
<body class="text-white">
    
    <!-- Header -->
    <div class="bg-black/30 backdrop-blur-md shadow-xl">
        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="text-center">
                <h1 class="text-3xl sm:text-4xl font-bold mb-2">Bendiciones para ti! - 20 Oportunidades</h1>
                <div class="mt-2 flex flex-wrap items-center justify-center gap-2">
                    <button onclick="showTerms()" class="inline-flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-indigo-300" aria-label="Ver Términos y Condiciones" title="Ver Términos y Condiciones">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" class="opacity-90">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" class="text-white/80"></circle>
                            <path d="M11.25 10.5h1.5v5.25h-1.5V10.5zM12 8.25a.75.75 0 100-1.5.75.75 0 000 1.5z" fill="currentColor" class="text-white"></path>
                        </svg>
                        <span>Ver información / Términos</span>
                    </button>
                    <button onclick="openPurchaseForm()" class="inline-flex items-center gap-2 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg text-sm sm:text-base focus:outline-none focus:ring-2 focus:ring-indigo-300" aria-label="Comprar Boleta" title="Comprar Boleta">
                        🎫 Adquirir
                    </button>
                </div>
                <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto items-start">
                    <div class="col-span-2 flex flex-col md:flex-row gap-4 items-stretch">
                        

                        <div class="flex-1 flex items-center justify-center">
                            <div id="carouselPrize" class="relative bg-white border border-gray-200 rounded-lg overflow-hidden mx-auto w-full max-w-[420px]">
                                <div class="relative w-full h-56 sm:h-72 md:h-80">
                                    <img src="img/p1.png" alt="Imagen 1" data-slide="0"
                                         class="absolute inset-0 m-auto w-full h-full object-contain transition-opacity duration-700 opacity-0">
                                </div>

                                
                            </div>

                            <script>
                                (function () {
                                    const carousel = document.getElementById('carouselPrize');
                                    if (!carousel) return;
                                    const slides = Array.from(carousel.querySelectorAll('img[data-slide]'));
                                    const dots = Array.from(carousel.querySelectorAll('[data-dot]'));
                                    let current = 0;
                                    let interval = null;

                                    const show = (i) => {
                                        slides.forEach((s, idx) => {
                                            s.classList.toggle('opacity-100', idx === i);
                                            s.classList.toggle('opacity-0', idx !== i);
                                        });
                                        dots.forEach((d, idx) => {
                                            d.classList.toggle('bg-white/80', idx === i);
                                            d.classList.toggle('bg-white/20', idx !== i);
                                        });
                                        current = i;
                                    };
                                    const next = () => show((current + 1) % slides.length);

                                    // Init
                                    show(0);
                                    interval = setInterval(next, 2500);

                                    // Pause on hover / touch
                                    carousel.addEventListener('mouseenter', () => clearInterval(interval));
                                    carousel.addEventListener('mouseleave', () => { clearInterval(interval); interval = setInterval(next, 2500); });
                                    carousel.addEventListener('touchstart', () => clearInterval(interval), {passive: true});
                                    carousel.addEventListener('touchend', () => { clearInterval(interval); interval = setInterval(next, 2500); });

                                    // Manual dot click
                                    dots.forEach(d => d.addEventListener('click', (e) => {
                                        const idx = Number(e.currentTarget.getAttribute('data-dot'));
                                        show(idx);
                                    }));
                                })();
                            </script>
                        </div>
                        <div class="flex-1 bg-yellow-400/10 border border-yellow-400 rounded-lg p-6 sm:p-8 text-center flex flex-col justify-center items-center min-h-[220px]">
                            <p class="text-sm text-gray-200 mb-3">El bendecido podrá elegir UNA de las siguientes opciones:</p>
                            <p class="text-x1 sm:text-2xl font-semibold text-white">• LAPTOP GAMER</p>
                            <p class="text-xl sm:text-2xl font-bold text-green-400 my-2">• $ 3.000.000 COP</p>
                            <p class="text-sm text-gray-300 mt-3">Para el que tenga el número ganador inverso o alrevez ( ejemplo: 123. Invertido -> 321 ). Obtiene:</p>
                            <p class="text-lg sm:text-xl font-bold text-indigo-300 mt-2">$700.000</p>
                            <p class="text-sm text-yellow-300 mt-3">Se sorteara el 05 de diciembre de 2025</p>
                        </div>
                    </div>
                    

                    <!-- Calendario de sorteos y estadísticas -->
                    <div class="col-span-2 flex flex-col md:flex-row gap-4 items-stretch">
                        <!-- Calendario izquierda -->
                        <div class="flex-1 bg-white/5 border border-white/20 rounded-lg p-4">
                            <div class="space-y-3 text-sm text-gray-200">
                                <div class="p-3 bg-black/30 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-bold">7 de noviembre de 2025</p>
                                            <p class="text-gray-300 text-xs">Santander</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-semibold text-green-300">300.000</p>
                                            <p class="text-xs text-indigo-300">100.000 (invertido)</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="p-3 bg-black/30 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-bold">14 de noviembre de 2025</p>
                                            <p class="text-gray-300 text-xs">Santander</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-semibold text-green-300">400.000</p>
                                            <p class="text-xs text-indigo-300">100.000 (invertido)</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="p-3 bg-black/30 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-bold">21 de noviembre de 2025</p>
                                            <p class="text-gray-300 text-xs">Santander</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-semibold text-green-300">500.000</p>
                                            <p class="text-xs text-indigo-300">150.000 (invertido)</p>
                                        </div>
                                    </div>
                                </div>

                                <div class="p-3 bg-black/30 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="font-bold">28 de noviembre de 2025</p>
                                            <p class="text-gray-300 text-xs">Santander</p>
                                        </div>
                                        <div class="text-right">
                                            <p class="font-semibold text-green-300">600.000</p>
                                            <p class="text-xs text-indigo-300">200.000 (invertido)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Estadísticas derecha -->
                        <div class="flex-1 flex flex-col gap-4">
                            <div class="bg-white/10 rounded-lg p-4 flex-1">
                                <p class="text-sm text-gray-300">Valor boleta</p>
                                <p class="text-2xl font-bold">$30.000</p>
                                <p class="text-xs text-yellow-300 mt-1">Aparta desde $5.000</p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-4 flex-1">
                                <p class="text-sm text-gray-300">Boletas vendidas</p>
                                <p class="text-2xl font-bold"><span id="soldPercentage" class="text-green-400">0%</span></p>
                            </div>
                            <div class="bg-white/10 rounded-lg p-4 flex-1">
                                <p class="text-sm text-gray-300">Próximo sorteo</p>
                                <p class="text-lg font-bold" id="nextDrawDate">-</p>
                                <p class="text-xs text-gray-300">Sorteo Semanal</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 max-w-4xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Countdown a la izquierda -->
                        <div class="bg-red-600/20 border-2 border-red-400 rounded-lg p-4">
                            <p class="text-sm font-semibold mb-2">Tiempo para la siguiente bendicion!</p>
                            <p id="countdown" class="text-3xl font-mono font-bold">Calculando...</p>
                        </div>

                        <!-- Información a la derecha -->
                        <div class="bg-blue-500/20 border border-blue-400 rounded-lg p-6">
                            <p class="text-sm">
                                
                                Para participar en la BS 1 y 2: paga mínimo el 50% (15.000).<br>
                                Para participar en la BS 3 y 4: paga el volor total de (30.000).<br>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Botón flotante de WhatsApp (preguntas) -->
    <div id="whatsappFloating" class="fixed bottom-6 right-6 z-50">
        <a
            href="https://wa.me/573151371553?text=Hola%2C%20tengo%20una%20pregunta%20sobre%20las%20bendiciones."
            target="_blank"
            rel="noopener noreferrer"
            onclick="{ openWhatsAppManual2(); }"
            class="group w-14 h-14 sm:w-16 sm:h-16 bg-green-600 hover:bg-green-500 text-white rounded-full flex items-center justify-center shadow-xl transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-300"
            aria-label="WhatsApp - Preguntas"
            title="Preguntas por WhatsApp"
        >
            <!-- Icono WhatsApp (SVG) -->
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true" class="pointer-events-none">
                <path d="M20.52 3.48A11.85 11.85 0 0012 .5C6.21.5 1.5 5.21 1.5 11c0 1.94.51 3.78 1.48 5.42L.5 23.5l7.35-2.03A11.44 11.44 0 0012 22.5c5.79 0 10.5-4.71 10.5-10.5 0-3.03-1.18-5.84-3.98-8.52z" fill="#fff" opacity="0.06"/>
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.472-.148-.672.149-.198.297-.768.967-.942 1.166-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.885-.789-1.48-1.763-1.653-2.06-.173-.297-.018-.458.13-.606.134-.133.298-.347.447-.52.151-.173.2-.297.3-.495.099-.198.05-.371-.025-.52-.075-.149-.672-1.62-.921-2.222-.242-.583-.487-.503-.672-.513l-.573-.01c-.198 0-.52.074-.792.371s-1.04 1.016-1.04 2.479 1.065 2.876 1.213 3.074c.149.198 2.095 3.2 5.077 4.487  .71.306 1.262.489 1.694.626.712.227 1.36.195 1.872.118.572-.086 1.758-.718 2.006-1.412.248-.694.248-1.289.173-1.412-.074-.123-.273-.198-.57-.347z" fill="#fff"/>
            </svg>

            <!-- Indicador pequeño (opcional) -->
            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5">?</span>
        </a>
    </div>
    <!-- Botón Comprar -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="text-center mb-6">
            <button onclick="openPurchaseForm()" class="bg-green-500 hover:bg-blue-500 text-white font-bold py-4 px-6 sm:px-8 rounded-lg text-lg sm:text-xl shadow-lg transform hover:scale-105 transition-all w-full sm:w-auto focus:outline-none focus:ring-2 focus:ring-blue-200">
                🎫 Adquirir
            </button>
        </div>

        <button onclick="showTerms()" class="bg-white/10 hover:bg-white/20 rounded-lg px-6 py-3 mb-6 transition-all mx-auto block">
            📋 Ver Términos y Condiciones
        </button>
    </div>

    <!-- Modal Formulario Compra (Bootstrap) -->
    <div class="modal fade" id="purchaseModal" tabindex="-1" aria-labelledby="purchaseModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
            <div class="modal-content bg-[#071125] ">
                <div class="modal-header ">
                    <h1 class="modal-title text-green-500 font-bold text-center text-3xl w-100" id="purchaseModalLabel">Comprar Boleta</h1>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div>
                        <label class="block text-sm font-semibold mb-2">Nombre completo *</label>
                        <input type="text" id="inputName" required minlength="4" class="w-full px-4 py-2 rounded-lg bg-gray-700 focus:border-yellow-400 focus:outline-none text-white" placeholder="Mínimo 4 caracteres">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Correo electrónico *</label>
                        <input type="email" id="inputEmail" required pattern=".+@.+" title="El correo debe contener @" class="w-full px-4 py-2 rounded-lg bg-gray-700 focus:border-yellow-400 focus:outline-none text-white" placeholder="usuario@ejemplo.com">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Celular *</label>
                        <input type="tel" id="inputPhone" required minlength="10" pattern="\d{10,}" oninput="this.value = this.value.replace(/\D/g,'')" placeholder="3001234567" class="w-full px-4 py-2 rounded-lg bg-gray-700 focus:border-yellow-400 focus:outline-none text-white">
                        <p class="text-xs text-gray-300 mt-1">Mínimo 10 dígitos (solo números)</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Dirección completa *</label>
                        <input type="text" id="inputAddress" required placeholder="Calle, Carrera, Barrio, Ciudad" class="w-full px-4 py-2 rounded-lg bg-gray-700 focus:border-yellow-400 focus:outline-none text-white">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Método de pago *</label>
                        <select id="inputPayment" required onchange="updatePaymentInfo()" class="w-full px-4 py-2 rounded-lg bg-white/20 focus:border-yellow-400 focus:outline-none text-white">
                            <option value="" style="color: #000;">Seleccionar...</option>
                            <option value="Nequi" style="color: #000;">Nequi</option>
                            <option value="Llaves" style="color: #000;">Llaves</option>
                            <option value="Efectivo" style="color: #000;">Efectivo</option>
                            <option value="Otro" style="color: #000;">Otro</option>
                        </select>
                    </div>

                    <div id="paymentInfo" class="hidden mt-3 bg-white/5 border border-white/20 rounded-lg p-3 text-sm text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="methodLabel font-semibold">Nequi</div>
                                <div class="mt-1">Número: <span id="paymentNumber" class="font-mono">3103535483</span></div>
                                <div class="text-xs text-gray-300 mt-1">Puedes copiar el número para realizar el pago.</div>
                            </div>
                            <div class="flex flex-col gap-2 ml-4">
                                <button onclick="copyPaymentNumber()" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-lg text-sm">
                                    Copiar número
                                </button>
                            </div>
                        </div>
                    </div>

                    <script>
                    (function () {
                        function updatePaymentInfo() {
                            const sel = (document.getElementById('inputPayment') || {}).value;
                            const info = document.getElementById('paymentInfo');
                            const numEl = document.getElementById('paymentNumber');
                            const methodLabel = info?.querySelector('.methodLabel');

                            if (!info || !numEl) return;

                            if (sel === 'Nequi' || sel === 'Llaves') {
                                numEl.textContent = '3103535483';
                                methodLabel.textContent = sel === 'Nequi' ? 'Nequi' : 'Llave';
                                info.classList.remove('hidden');
                            } else {
                                info.classList.add('hidden');
                            }
                        }

                        async function copyPaymentNumber() {
                            const num = document.getElementById('paymentNumber').textContent.trim();
                            if (!num) return alert('No hay número para copiar');
                            try {
                                await navigator.clipboard.writeText(num);
                                alert('Número copiado: ' + num);
                            } catch (e) {
                                // Fallback
                                const inp = document.createElement('input');
                                inp.value = num;
                                document.body.appendChild(inp);
                                inp.select();
                                document.execCommand('copy');
                                inp.remove();
                                alert('Número copiado: ' + num);
                            }
                        }

                        window.updatePaymentInfo = updatePaymentInfo;
                        window.copyPaymentNumber = copyPaymentNumber;

                        // Si el select ya tiene valor (p. ej. edición), actualizar la vista al cargar
                        document.addEventListener('DOMContentLoaded', updatePaymentInfo);
                    })();
                    </script>

                    <div>
                        <label class="block text-sm font-semibold mb-2">Monto para apartar(mínimo $5.000) *</label>
                        <input type="number" id="inputAmount" required min="5000" max="30000" value="5000" step="1000" class="w-full px-4 py-2 rounded-lg bg-gray-700 focus:border-yellow-400 focus:outline-none text-white">
                        <p class="text-xs text-gray-300 mt-1 mb-2">Valor total: $30.000</p>
                    </div>

                    <script>
                    (function(){
                        function validatePurchaseFields(){
                            const name = (document.getElementById('inputName')?.value || '').trim();
                            const email = (document.getElementById('inputEmail')?.value || '').trim();
                            const phone = (document.getElementById('inputPhone')?.value || '').replace(/\D/g,'').trim();

                            if (name.length < 4) {
                                alert('❌ El nombre debe tener al menos 4 caracteres');
                                document.getElementById('inputName').focus();
                                return false;
                            }
                            if (!email.includes('@')) {
                                alert('❌ El correo debe contener "@"');
                                document.getElementById('inputEmail').focus();
                                return false;
                            }
                            if (phone.length < 10) {
                                alert('❌ El celular debe tener al menos 10 dígitos');
                                document.getElementById('inputPhone').focus();
                                return false;
                            }
                            return true;
                        }

                        // Interceptar clicks al botón Comprar (inline onclick="submitPurchase()") en etapa de captura
                        document.addEventListener('click', function(e){
                            const btn = e.target.closest('button[onclick="submitPurchase()"]');
                            if (!btn) return;
                            if (!validatePurchaseFields()){
                                e.stopImmediatePropagation();
                                e.preventDefault();
                            }
                        }, true);
                    })();
                    </script>

                    <div class="bg-gray-700 rounded-lg p-2 mb-3">
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input type="checkbox" id="inputTerms" required class="mt-1 w-3 h-3">
                            <span class="text-sm">
                                Acepto los términos.
                            </span>
                        </label>
                    </div>

                    <div class="flex gap-3 flex-col sm:flex-row">
                        <button type="button" class="w-full sm:flex-1 bg-gray-600 hover:bg-gray-500 py-3 rounded-lg font-semibold" data-bs-dismiss="modal">
                            Cancelar
                        </button>
                        <button onclick="submitPurchase()" class="w-full sm:flex-1 bg-green-600 hover:bg-green-500 py-3 rounded-lg font-semibold">
                            Comprar
                        </button>
                    </div>                   
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Éxito -->
    <div id="successModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div class="bg-green-600 rounded-xl p-8 max-w-md w-full text-center">
            <div class="text-6xl mb-4 animate-bounce">✅</div>
            <h3 class="text-2xl font-bold mb-4">¡Compra Registrada!</h3>
            <div class="bg-white/20 rounded-lg p-4 mb-4 text-left">
                <p class="font-bold text-center mb-2">Boleta #<span id="successTicketNum"></span></p>
                <p class="text-sm">📧 Recibirás un correo con tus números</p>
                <p class="text-sm mt-2">Valor a pagar: $<span id="successAmount"></span></p>
                <p class="text-sm">⏳ Pendiente: $<span id="successPending"></span></p>
            </div>
            <p class="text-sm mb-4">📱 Se abrirá WhatsApp para enviar tu comprobante</p>
            <button id="whatsappBtn" onclick="openWhatsAppManual()" class="w-full bg-green-800 hover:bg-green-700 py-3 rounded-lg font-semibold mb-2">
                💬 Abrir WhatsApp Ahora
            </button>
            <script>
            (function(){
                const modal = document.getElementById('successModal');
                if (!modal) return;

                // Function to attempt opening WhatsApp (safe)
                const tryOpenWhatsApp = () => {
                    try {
                        // small delay to ensure lastPurchaseData is populated
                        setTimeout(() => {
                            if (typeof openWhatsAppManual === 'function') openWhatsAppManual();
                        }, 1000);
                    } catch (e) {
                        console.error('WhatsApp open error', e);
                    }
                };

                // If modal already visible, open immediately (with small delay)
                if (!modal.classList.contains('hidden')) tryOpenWhatsApp();

                // Watch for modal becoming visible and open WhatsApp once
                const obs = new MutationObserver((mutations, observer) => {
                    for (const m of mutations) {
                        if (m.attributeName === 'class' && !modal.classList.contains('hidden')) {
                            tryOpenWhatsApp();
                            observer.disconnect();
                            break;
                        }
                    }
                });

                obs.observe(modal, { attributes: true });
            })();
            </script>
        </div>
    </div>

    <!-- Modal Términos -->
    <div id="termsModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white text-gray-900 rounded-xl p-6 max-w-2xl w-full my-8">
            <h3 class="text-2xl font-bold mb-4">Términos y Condiciones</h3>
            <div class="space-y-4 text-sm max-h-96 overflow-y-auto">
                <section>
                    <h4 class="font-bold text-lg mb-2">1. Sistema de Bendiciones</h4>
                    <p>• 4 Bendiciones + 1 bendicion final (5 de diciembre 2025)</p>
                    <p>• Cada boleta tiene 2 números asignados aleatoriamente (000-999)</p>
                    <p>• Con cada numero tienes 10 oportunidades de ganar un premio para un total de 20 oportunidades</p>
                    <p>• El número inverso también participa, ejemplo: (123-321)</p>
                </section>
                <section>
                    <h4 class="font-bold text-lg mb-2">2. Pagos y Elegibilidad</h4>
                    <p>• Puedes apartar desde 5,000 y seguir abonando poco a poco. Precio total: $30.000</p>
                    <p>• Para participar en los 2 primeros sorteos debes haber pagado el 50% del valor total (15,000)</p>
                    <p>• Para participar en los siguientes 2 sorteos debes haber pagado el 100% del valor total (30,000)</p>
                    <p>• Asi todos al haber pagado la totalidad de la boleta participan para el premio mayor</p>
                    <p>• Recibirás notificación por el grupo de WhastApp de los ganadores cada semana!</p>
                    <p>• Mucha Suerte!</p>
                </section>
                <section>
                    <h4 class="font-bold text-lg mb-2">3. Números y Notificaciones</h4>
                    <p>• Tus números se envían por correo después de comprar con el valor minimo de $ 5,000</p>
                    <p>• Todos los sorteos son realizados los viernes con la loteria de Santander</p>
                </section>
                <section>
                    <h4 class="font-bold text-lg mb-2">4. Responsable y Contacto</h4>
                    <p>• Autor Emil Sanchez</p>
                    <p>• Responsable Emil Sanchez</p>
                    <p>• Telefono: 3103535483</p>
                    <p>• Correo: bendicionesemil@gmail.com</p>
                </section>
            </div>
            <button onclick="closeTerms()" class="w-full mt-6 bg-blue-600 hover:bg-purple-700 text-white py-3 rounded-lg font-semibold">
                Cerrar
            </button>
        </div>
        
    </div>
    <div class="border-t border-white/20 pt-6">
        <div class="text-center text-sm text-gray-400">
            <p class="mb-2">© 2025. Todos los derechos reservados. Emil Sanchez</p>
        </div>
    </div>

    <!-- Panel Admin -->
    <div id="adminPanel" class="hidden fixed inset-0 bg-black/95 z-50 overflow-y-auto">
        <div class="max-w-7xl mx-auto p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold">🔑 Panel Administrador</h2>
                <button onclick="toggleAdmin()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg">Cerrar</button>
            </div>

            <div id="adminLogin" class="bg-white/10 rounded-lg p-6 mb-6">
                <h3 class="text-xl font-bold mb-4">Contraseña</h3>
                <div class="flex gap-3">
                    <input type="password" id="adminPassword" placeholder="Contraseña" class="flex-1 px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                    <button onclick="loginAdmin()" class="bg-green-600 px-6 py-2 rounded-lg font-semibold">Entrar</button>
                </div>
            </div>

            <div id="adminContent" class="hidden space-y-6">
                <!-- Pestañas de navegación -->
                <div class="flex gap-2 bg-white/10 p-2 rounded-lg overflow-x-auto">
                    <button onclick="switchAdminTab('search')" id="tabSearch" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap bg-blue-600">
                        🎯 Buscar Ganador
                    </button>
                    <button onclick="switchAdminTab('numbers')" id="tabNumbers" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap bg-white/20">
                        🔢 Números
                    </button>
                    <button onclick="switchAdminTab('database')" id="tabDatabase" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap bg-white/20">
                        💾 Base de Datos
                    </button>
                    <button onclick="switchAdminTab('payment')" id="tabPayment" class="px-4 py-2 rounded-lg font-semibold whitespace-nowrap bg-white/20">
                        💰 Abonos
                    </button>
                </div>

                <!-- Tab: Buscar Ganador -->
                <div id="contentSearch" class="bg-white/10 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">🎯 Buscar Ganador</h3>
                    <div class="flex gap-3">
                        <input type="number" id="winningNumber" placeholder="Ej: 347" min="0" max="999" class="flex-1 px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                        <button onclick="findWinner()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-semibold">Buscar</button>
                    </div>
                    <div id="winnerResult" class="mt-4"></div>
                </div>

                <!-- Tab: Números -->
                <div id="contentNumbers" class="hidden bg-white/10 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">🔢 Gestión de Números</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-green-900/30 border border-green-500 rounded-lg p-4">
                            <h4 class="font-bold text-lg mb-2 text-green-400">Números Disponibles</h4>
                            <p class="text-3xl font-bold mb-2" id="availableCount">-</p>
                            <p class="text-sm text-gray-300">de 1000 números totales</p>
                        </div>
                        <div class="bg-red-900/30 border border-red-500 rounded-lg p-4">
                            <h4 class="font-bold text-lg mb-2 text-red-400">Números Asignados</h4>
                            <p class="text-3xl font-bold mb-2" id="assignedCount">-</p>
                            <p class="text-sm text-gray-300">números en uso</p>
                        </div>
                    </div>

                    <div class="mb-4">
                        <input type="text" id="searchNumber" placeholder="Buscar número específico (ej: 347)" class="w-full px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white mb-2">
                        <div class="flex gap-2">
                            <button onclick="searchSpecificNumber()" class="flex-1 bg-purple-600 hover:bg-purple-500 py-2 rounded-lg font-semibold">
                                🔍 Buscar
                            </button>
                            <button onclick="showAllNumbers('available')" class="flex-1 bg-green-600 hover:bg-green-500 py-2 rounded-lg font-semibold">
                                Ver Disponibles
                            </button>
                            <button onclick="showAllNumbers('assigned')" class="flex-1 bg-red-600 hover:bg-red-500 py-2 rounded-lg font-semibold">
                                Ver Asignados
                            </button>
                        </div>
                    </div>
                    
                    <div id="numbersResult" class="mt-4 max-h-96 overflow-y-auto"></div>
                </div>

                <!-- Tab: Base de Datos -->
                <div id="contentDatabase" class="hidden bg-white/10 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">💾 Base de Datos Completa</h3>
                    
                    <div class="mb-4 flex gap-3 flex-wrap">
                        <input type="text" id="searchDatabase" placeholder="Buscar por nombre, correo, teléfono..." class="flex-1 min-w-[250px] px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                        <select id="filterStatus" class="px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                            <option value="all">Todos</option>
                            <option value="pagado">Pagados</option>
                            <option value="abonado">Abonados</option>
                        </select>
                        <button onclick="filterDatabase()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-semibold">
                            Filtrar
                        </button>
                        <button onclick="exportToCSV()" class="bg-green-600 hover:bg-green-500 px-6 py-2 rounded-lg font-semibold">
                            📥 Exportar CSV
                        </button>
                    </div>

                    <div class="bg-black/30 rounded p-3 mb-4 text-sm">
                        <div class="grid grid-cols-3 gap-4">
                            <div>
                                <p class="text-gray-400">Total Boletas:</p>
                                <p class="text-xl font-bold" id="dbTotalTickets">0</p>
                            </div>
                            <div>
                                <p class="text-gray-400">Pagadas Completo:</p>
                                <p class="text-xl font-bold text-green-400" id="dbPaidTickets">0</p>
                            </div>
                            <div>
                                <p class="text-gray-400">Con Abonos:</p>
                                <p class="text-xl font-bold text-yellow-400" id="dbPartialTickets">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                    <table class="w-full text-sm" id="databaseTable">
                        <thead class="bg-black/50">
                            <tr>
                                <th class="px-3 py-2 text-left">#</th>
                                <th class="px-3 py-2 text-left">Números</th>
                                <th class="px-3 py-2 text-left">Nombre</th>
                                <th class="px-3 py-2 text-left">Contacto</th>
                                <th class="px-3 py-2 text-left">Pago</th>
                                <th class="px-3 py-2 text-left">Estado</th>
                                <th class="px-3 py-2 text-center">Confirmada</th>
                                <th class="px-3 py-2 text-left">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="databaseTableBody" class="divide-y divide-white/10">
                        </tbody>
                    </table>
                </div>

                <!-- Tab: Abonos -->
                <div id="contentPayment" class="hidden bg-white/10 rounded-lg p-6">
                    <h3 class="text-xl font-bold mb-4">💰 Registrar Abono Manual</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="manualTicketNum" placeholder="# Boleta" min="1" max="500" class="px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                        <input type="number" id="manualAmount" placeholder="Monto" min="1000" class="px-4 py-2 rounded-lg bg-white/20 border border-white/30 text-white">
                        <button onclick="registerManualPayment()" class="col-span-2 bg-green-600 hover:bg-green-500 py-2 rounded-lg font-semibold">Registrar Pago</button>
                    </div>
                    
                    <div class="mt-6 bg-black/30 rounded-lg p-4">
                        <h4 class="font-bold mb-3">Historial de Abonos Recientes</h4>
                        <div id="recentPayments" class="space-y-2 max-h-64 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>
    </div> 
    

<script type="module">
/* ============================================
   CONFIGURACIÓN - CAMBIAR ESTOS VALORES
============================================ */

// 🔥 FIREBASE CONFIG
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
import { getDatabase, ref, set, onValue, get, push, update } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBOuEPesCNGxWxKxcJuPbGnNHJArBuj7Nc",
    authDomain: "rifa-universitaria-657c8.firebaseapp.com",
    databaseURL: "https://rifa-universitaria-657c8-default-rtdb.firebaseio.com",
    projectId: "rifa-universitaria-657c8",
    storageBucket: "rifa-universitaria-657c8.firebasestorage.app",
    messagingSenderId: "173786953583",
    appId: "1:173786953583:web:7275693fc0948a65b35a9a"
};

// 📧 EMAILJS CONFIG
const EMAILJS_CONFIG = {
    serviceId: 'service_rmmvmgl',      
    templateId: 'template_i7n2zrg',    
    publicKey: 'RnZvnfPFR7wtF3oM9'       
};

// 💰 CONFIGURACIÓN DE PRECIOS Y ELEGIBILIDAD
const TICKET_PRICE = 30000;
const MIN_PAYMENT = 5000;
const eligibilityThresholds = {
    week1: 15000,
    week2: 15000,
    week3: 25000,
    week4: 30000,
    week5: 30000
};

// 📅 FECHAS DE SORTEOS
const weeklyCutoffs = {
    week1: new Date('2025-11-07T23:59:59'),
    week2: new Date('2025-11-14T23:59:59'),
    week3: new Date('2025-11-21T23:59:59'),
    week4: new Date('2025-11-22T23:59:59'),
    week5: new Date('2025-12-05T23:59:59')
};

const FINAL_DRAW_DATE = new Date('2025-12-06T20:00:00');
const WHATSAPP_NUMBER = '573151371553';
const ADMIN_PASSWORD = '210621#';
const TOTAL_TICKETS = 500;
const DEBUG = false; // Cambiar a false en producción

/* ============================================
   ✅ CORRECCIÓN 1: Variable global para WhatsApp
============================================ */
let lastPurchaseData = null;

/* ============================================
   INICIALIZACIÓN
============================================ */
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Inicializar EmailJS
emailjs.init(EMAILJS_CONFIG.publicKey);

// Pool de números disponibles (000-999)
let availableNumbers = [];
let assignedNumbers = {}; 
let isAdminLoggedIn = false;
let currentAdminTab = 'search';
let allTicketsCache = [];

function initializeNumberPool() {
    availableNumbers = [];
    for (let i = 0; i <= 999; i++) {
        availableNumbers.push(String(i).padStart(3, '0'));
    }
}

initializeNumberPool();

/* ============================================
   ✅ CORRECCIÓN 2: Sistema de logs mejorado
============================================*/

function log(type, message, data = null) {
    if (!DEBUG) return;
    
    const timestamp = new Date().toLocaleTimeString('es-CO');
    const emoji = {
        success: '✅',
        error: '❌',
        warning: '⚠️',
        info: 'ℹ️'
    }[type] || '📝';
    
    
}

/* ============================================
   FUNCIONES AUXILIARES
============================================ */

// Asignar 2 números aleatorios
function assignRandomNumbers() {
    if (availableNumbers.length < 2) {
        throw new Error('No hay suficientes números disponibles');
    }
    
    const nums = [];
    for (let i = 0; i < 2; i++) {
        const idx = Math.floor(Math.random() * availableNumbers.length);
        nums.push(availableNumbers[idx]);
        availableNumbers.splice(idx, 1);
    }
    return nums.sort();
}

// Calcular elegibilidad por semana
function calculateEligibility(amountPaid, paymentDate) {
    const eligible = {};
    const pDate = new Date(paymentDate);
    
    Object.keys(eligibilityThresholds).forEach(week => {
        const threshold = eligibilityThresholds[week];
        const cutoff = weeklyCutoffs[week];
        
        eligible[week] = (amountPaid >= threshold) && (pDate <= cutoff);
    });
    
    return eligible;
}

// Calcular número invertido
function getInvertedNumber(num) {
    return num.split('').reverse().join('');
}

/* ============================================
   ✅ CORRECCIÓN 3: Validación robusta de emails
============================================ */
async function sendEmail(templateParams) {
    try {
        // Validar email del destinatario
        const recipientEmail = templateParams.email || templateParams.to_email;
        
        if (!recipientEmail || recipientEmail.trim() === '') {
            log('error', 'Email vacío', templateParams);
            throw new Error('Email del destinatario está vacío');
        }
        
        // Validar formato de email
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(recipientEmail)) {
            throw new Error('Formato de email inválido: ' + recipientEmail);
        }
        
        log('info', 'Enviando correo a:', recipientEmail);
        
        const response = await emailjs.send(
            EMAILJS_CONFIG.serviceId,
            EMAILJS_CONFIG.templateId,
            {
                ...templateParams,
                to_email: recipientEmail // Asegurar campo correcto
            }
        );
        
        log('success', 'Correo enviado', response);
        return true;
        
    } catch (error) {
        log('error', 'Error enviando correo', error);
        
        const errorMsg = error.text || error.message || 'Error desconocido';
        alert(`⚠️ No se pudo enviar el correo: ${errorMsg}`);
        
        return false;
    }
}

/* ============================================
   ACTUALIZAR UI PÚBLICA
============================================ */
onValue(ref(db, 'tickets'), (snapshot) => {
    const data = snapshot.val() || {};
    const tickets = Object.values(data);
    
    // Contar TODAS las boletas registradas (no solo pagadas)
    const totalSold = tickets.length;
    const percentage = ((totalSold / TOTAL_TICKETS) * 100).toFixed(2);
    
    document.getElementById('soldPercentage').textContent = percentage + '%';
});

// Actualizar contador próximo sorteo
function updateCountdown() {
    const now = new Date();
    let nextDraw = null;
    
    Object.values(weeklyCutoffs).forEach(cutoff => {
        if (cutoff > now && (!nextDraw || cutoff < nextDraw)) {
            nextDraw = cutoff;
        }
    });
    
    if (!nextDraw) nextDraw = FINAL_DRAW_DATE;
    
    const diff = nextDraw - now;
    if (diff <= 0) {
        document.getElementById('countdown').textContent = '¡Sorteo!';
        return;
    }
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const secs = Math.floor((diff % (1000 * 60)) / 1000);
    
    document.getElementById('countdown').textContent = `${days}d ${hours}h ${mins}m ${secs}s`;
    document.getElementById('nextDrawDate').textContent = nextDraw.toLocaleDateString('es-CO');
}

setInterval(updateCountdown, 1000);
updateCountdown();

//

/* ============================================
   COMPRA DE BOLETAS
============================================ */
function openPurchaseForm() {
    const purchaseModal = new bootstrap.Modal(document.getElementById('purchaseModal'));
    purchaseModal.show();
}

function closePurchaseForm() {
    const purchaseModal = bootstrap.Modal.getInstance(document.getElementById('purchaseModal'));
    if (purchaseModal) {
        purchaseModal.hide();
    }
}

/* ============================================
   ✅ CORRECCIÓN 4: submitPurchase con auto-WhatsApp
============================================ */
async function submitPurchase() {
    const name = document.getElementById('inputName').value.trim();
    const email = document.getElementById('inputEmail').value.trim();
    const phone = document.getElementById('inputPhone').value.trim();
    const address = document.getElementById('inputAddress').value.trim();
    const payment = document.getElementById('inputPayment').value;
    const amount = parseInt(document.getElementById('inputAmount').value);
    const terms = document.getElementById('inputTerms').checked;
    
    log('info', 'Iniciando compra', { name, email, amount });
    
    if (!name || !email || !phone || !address || !payment) {
        alert('❌ Completa todos los campos');
        return;
    }
    
    if (!terms) {
        alert('❌ Debes aceptar los términos');
        return;
    }
    
    if (amount < MIN_PAYMENT || amount > TICKET_PRICE) {
        alert(`❌ Monto debe estar entre ${MIN_PAYMENT.toLocaleString('es-CO')} y ${TICKET_PRICE.toLocaleString('es-CO')}`);
        return;
    }
    
    const btnComprar = document.querySelector('button[onclick="submitPurchase()"]');

    if (btnComprar) {
        btnComprar.disabled = true;
        btnComprar.textContent = 'Procesando...';
    }

    // ✅ CERRAR EL MODAL DESPUÉS DE 2 SEGUNDOS
    setTimeout(() => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('purchaseModal'));
        if (modal) {
            modal.hide();
        }
        
        // Limpiar formulario
        document.getElementById('inputName').value = '';
        document.getElementById('inputEmail').value = '';
        document.getElementById('inputPhone').value = '';
        document.getElementById('inputAddress').value = '';
        document.getElementById('inputPayment').value = '';
        document.getElementById('inputAmount').value = '5000';
        document.getElementById('inputTerms').checked = false;
        
        // Rehabilitar botón
        if (btnComprar) {
            btnComprar.disabled = false;
            btnComprar.textContent = 'Comprar';
        }
    }, 2000);
    
    try {
        // ✅ CORREGIDO: Generar número de boleta (buscar el más alto y sumar 1)
        const snapshot = await get(ref(db, 'tickets'));
        const existingTickets = snapshot.val() || {};
        
        let ticketNumber = 1;
        if (Object.keys(existingTickets).length > 0) {
            const existingNumbers = Object.values(existingTickets).map(t => t.ticketNumber);
            ticketNumber = Math.max(...existingNumbers) + 1;
        }
        
        if (ticketNumber > TOTAL_TICKETS) {
            alert('❌ Ya no hay boletas disponibles');
            return;
        }
        
        // Asignar números aleatorios
        const assignedNumbers = assignRandomNumbers();
        const now = new Date().toISOString();
        const eligible = calculateEligibility(amount, now);
        
        // Crear ticket
        const ticketData = {
            ticketNumber,
            numerosAsignados: assignedNumbers,
            nombre: name,
            correo: email,
            telefono: phone,
            direccion: address,
            amountPaid: amount,
            montoTotal: TICKET_PRICE,
            estadoPago: amount >= TICKET_PRICE ? 'pagado' : 'abonado',
            metodoPago: payment,
            reservedAt: now,
            lastPaymentAt: now,
            eligible: eligible,
            reservationStatus: 'pendiente',
            payments: [{ amount, date: now }]
        };
        
        // Guardar en Firebase
        await set(ref(db, `tickets/ticket_${ticketNumber}`), ticketData);
        
        log('success', 'Compra exitosa', { ticketNumber });
        
        // Guardar datos para WhatsApp
        const eligibleWeeks = Object.keys(eligible).filter(w => eligible[w]).join(', ') || 'Ninguna aún';
        const pending = TICKET_PRICE - amount;
        
        lastPurchaseData = {
            ticketNumber,
            assignedNumbers,
            name,
            email,
            phone,
            address,
            amount,
            pending,
            payment,
            eligibleWeeks
        };

        // Enviar correo
        await sendEmail({
            to_email: email,
            to_name: name,
            ticket_number: ticketNumber,
            assigned_numbers: `${assignedNumbers[0]} y ${assignedNumbers[1]}`,
            inverted1: getInvertedNumber(assignedNumbers[0]),
            inverted2: getInvertedNumber(assignedNumbers[1]),
            amount_paid: amount.toLocaleString('es-CO'),
            pending_amount: pending.toLocaleString('es-CO'),
            eligible_weeks: eligibleWeeks,
            week1_threshold: eligibilityThresholds.week1.toLocaleString('es-CO'),
            week1_cutoff: weeklyCutoffs.week1.toLocaleDateString('es-CO')
        });

        // Mostrar modal éxito
        document.getElementById('successTicketNum').textContent = ticketNumber;
        document.getElementById('successAmount').textContent = amount.toLocaleString('es-CO');
        document.getElementById('successPending').textContent = pending.toLocaleString('es-CO');
        document.getElementById('successModal').classList.remove('hidden');

        // ✅ Enfocar el botón de WhatsApp para facilitar el clic
        setTimeout(() => {
            const whatsappBtn = document.getElementById('whatsappBtn');
            if (whatsappBtn) {
                whatsappBtn.focus();
                // Hacer que parpadee para llamar la atención
                whatsappBtn.style.animation = 'pulse 1s infinite';
            }
        }, 500);

        // esperar 2 segundos
        await new Promise(resolve => setTimeout(resolve, 2000));

        // Abrir WhatsApp
        log('info', 'Abriendo WhatsApp');
        openWhatsAppManual();

        // Cerrar modal después de 15 segundos adicionales
        setTimeout(() => {
            document.getElementById('successModal').classList.add('hidden');
        }, 15000);
        
    } catch (error) {
        log('error', 'Error en compra', error);
        alert('❌ Error al procesar la compra: ' + error.message);
        
        // En caso de error, asegurarse de rehabilitar el botón
        if (btnComprar) {
            btnComprar.disabled = false;
            btnComprar.textContent = 'Comprar';
        }
    }
}

/* ============================================
   ✅ CORRECCIÓN 5: openWhatsAppManual arreglado
============================================ */
function openWhatsAppManual() {
    if (!lastPurchaseData) {
        log('warning', 'No hay datos de compra disponibles');
        alert('❌ No hay datos de compra disponibles');
        return;
    }
    
    const { ticketNumber, assignedNumbers, name, email, phone, address, amount, pending, payment, eligibleWeeks } = lastPurchaseData;
    
    const whatsappMessage = `

*Boleta #${ticketNumber}*
*Números:* ${assignedNumbers[0]} y ${assignedNumbers[1]}
*Invertidos:* ${getInvertedNumber(assignedNumbers[0])} y ${getInvertedNumber(assignedNumbers[1])}

*Datos del comprador:*
- Nombre: ${name}
- Email: ${email}
- Teléfono: ${phone}
- Dirección: ${address}

*Información de pago:*
- Monto a pagar: ${amount.toLocaleString('es-CO')}
- Pendiente: ${pending.toLocaleString('es-CO')}
- Método: ${payment}



_Por favor confirma el pago para activar la boleta._`;

    const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(whatsappMessage)}`;
    
    log('success', 'Abriendo WhatsApp', { ticketNumber });
    window.open(whatsappUrl, '_blank');
}

function openWhatsAppManual2() {
    const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(whatsappMessage)}`;
    
    log('success', 'Abriendo WhatsApp', { ticketNumber });
    window.open(whatsappUrl, '_blank');
}

/* ============================================
   PANEL ADMIN
============================================ */
function checkAdminAccess() {
    const urlParams = new URLSearchParams(window.location.search);
    const hash = window.location.hash;
    
    if (urlParams.get('admin') === 'true' || hash === '#admin') {
        document.getElementById('adminPanel').classList.remove('hidden');
    }
}

window.addEventListener('hashchange', () => {
    if (window.location.hash === '#admin') {
        document.getElementById('adminPanel').classList.remove('hidden');
    }
});

function toggleAdmin() {
    const panel = document.getElementById('adminPanel');
    panel.classList.toggle('hidden');
    
    if (panel.classList.contains('hidden')) {
        if (window.location.hash === '#admin') {
            history.pushState("", document.title, window.location.pathname + window.location.search);
        }
    }
}

function switchAdminTab(tabName) {
    document.getElementById('contentSearch').classList.add('hidden');
    document.getElementById('contentNumbers').classList.add('hidden');
    document.getElementById('contentDatabase').classList.add('hidden');
    document.getElementById('contentPayment').classList.add('hidden');
    
    document.getElementById('tabSearch').classList.remove('bg-blue-600');
    document.getElementById('tabNumbers').classList.remove('bg-blue-600');
    document.getElementById('tabDatabase').classList.remove('bg-blue-600');
    document.getElementById('tabPayment').classList.remove('bg-blue-600');
    
    document.getElementById('tabSearch').classList.add('bg-white/20');
    document.getElementById('tabNumbers').classList.add('bg-white/20');
    document.getElementById('tabDatabase').classList.add('bg-white/20');
    document.getElementById('tabPayment').classList.add('bg-white/20');
    
    document.getElementById('content' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.remove('hidden');
    document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.remove('bg-white/20');
    document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.add('bg-blue-600');
    
    if (tabName === 'numbers') {
        loadNumbersManagement();
    } else if (tabName === 'database') {
        loadDatabaseTable();
    } else if (tabName === 'payment') {
        loadRecentPayments();
    }
}

function loginAdmin() {
    if (document.getElementById('adminPassword').value === ADMIN_PASSWORD) {
        isAdminLoggedIn = true;
        document.getElementById('adminLogin').classList.add('hidden');
        document.getElementById('adminContent').classList.remove('hidden');
        switchAdminTab('search');
    } else {
        alert('❌ Contraseña incorrecta');
    }
}

// ============ GESTIÓN DE NÚMEROS ============
async function loadNumbersManagement() {
    const snapshot = await get(ref(db, 'tickets'));
    const data = snapshot.val() || {};
    const tickets = Object.values(data);
    
    const assignedNums = new Set();
    tickets.forEach(t => {
        if (t.numerosAsignados) {
            t.numerosAsignados.forEach(num => assignedNums.add(num));
        }
    });
    
    const allNumbers = [];
    for (let i = 0; i <= 999; i++) {
        allNumbers.push(String(i).padStart(3, '0'));
    }
    
    const available = allNumbers.filter(n => !assignedNums.has(n));
    
    document.getElementById('availableCount').textContent = available.length;
    document.getElementById('assignedCount').textContent = assignedNums.size;
    
    availableNumbers = [...available];
}

function searchSpecificNumber() {
    const searchNum = document.getElementById('searchNumber').value.trim().padStart(3, '0');
    
    if (searchNum.length !== 3 || isNaN(searchNum)) {
        alert('❌ Ingresa un número válido (0-999)');
        return;
    }
    
    get(ref(db, 'tickets')).then(snapshot => {
        const data = snapshot.val() || {};
        const tickets = Object.values(data);
        
        const found = tickets.filter(t => 
            t.numerosAsignados && t.numerosAsignados.includes(searchNum)
        );
        
        const resultDiv = document.getElementById('numbersResult');
        
        if (found.length === 0) {
            resultDiv.innerHTML = `
                <div class="bg-green-600/30 border border-green-500 rounded-lg p-4">
                    <p class="font-bold text-xl">✅ Número ${searchNum} está DISPONIBLE</p>
                    <p class="text-sm mt-2">Este número no ha sido asignado a ninguna boleta</p>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="bg-red-600/30 border border-red-500 rounded-lg p-4">
                    <p class="font-bold text-xl mb-3">❌ Número ${searchNum} está ASIGNADO</p>
                    ${found.map(t => `
                        <div class="bg-black/30 rounded p-3 mb-2">
                            <p class="font-bold">Boleta #${t.ticketNumber}</p>
                            <p class="text-sm">🔢 Números: ${t.numerosAsignados.join(' y ')}</p>
                            <p class="text-sm">👤 ${t.nombre}</p>
                            <p class="text-sm">📧 ${t.correo}</p>
                            <p class="text-sm">📱 ${t.telefono}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        }
    });
}

function showAllNumbers(type) {
    get(ref(db, 'tickets')).then(snapshot => {
        const data = snapshot.val() || {};
        const tickets = Object.values(data);
        
        const assignedNums = new Set();
        const assignedDetails = {};
        
        tickets.forEach(t => {
            if (t.numerosAsignados) {
                t.numerosAsignados.forEach(num => {
                    assignedNums.add(num);
                    if (!assignedDetails[num]) assignedDetails[num] = [];
                    assignedDetails[num].push(t);
                });
            }
        });
        
        const allNumbers = [];
        for (let i = 0; i <= 999; i++) {
            allNumbers.push(String(i).padStart(3, '0'));
        }
        
        const resultDiv = document.getElementById('numbersResult');
        
        if (type === 'available') {
            const available = allNumbers.filter(n => !assignedNums.has(n));
            
            resultDiv.innerHTML = `
                <div class="bg-green-900/30 border border-green-500 rounded-lg p-4">
                    <h4 class="font-bold text-xl mb-3">✅ Números Disponibles (${available.length})</h4>
                    <div class="grid grid-cols-10 gap-2 max-h-96 overflow-y-auto">
                        ${available.map(n => `
                            <div class="bg-green-600/50 rounded px-2 py-1 text-center text-sm font-mono">
                                ${n}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        } else {
            const assigned = Array.from(assignedNums).sort();
            
            resultDiv.innerHTML = `
                <div class="bg-red-900/30 border border-red-500 rounded-lg p-4">
                    <h4 class="font-bold text-xl mb-3">❌ Números Asignados (${assigned.length})</h4>
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        ${assigned.map(n => {
                            const tickets = assignedDetails[n];
                            return `
                                <div class="bg-black/30 rounded p-2 text-sm">
                                    <span class="font-bold font-mono text-red-400">${n}</span> → 
                                    ${tickets.map(t => `Boleta #${t.ticketNumber} (${t.nombre})`).join(', ')}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
    });
}

// ============ BASE DE DATOS ============
async function loadDatabaseTable() {
    const snapshot = await get(ref(db, 'tickets'));
    const data = snapshot.val() || {};
    const tickets = Object.values(data).sort((a, b) => a.ticketNumber - b.ticketNumber);
    
    const totalTickets = tickets.length;
    const paidTickets = tickets.filter(t => t.estadoPago === 'pagado').length;
    const partialTickets = tickets.filter(t => t.estadoPago === 'abonado').length;
    
    document.getElementById('dbTotalTickets').textContent = totalTickets;
    document.getElementById('dbPaidTickets').textContent = paidTickets;
    document.getElementById('dbPartialTickets').textContent = partialTickets;
    
    renderDatabaseTable(tickets);
}

/* ============================================
   ✅ CORRECCIÓN 6: Botón Confirmar Reserva agregado
============================================ */
function renderDatabaseTable(tickets) {
    const tbody = document.getElementById('databaseTableBody');
    
    if (tickets.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-gray-400">No hay boletas registradas</td></tr>';
        return;
    }
    
    tbody.innerHTML = tickets.map(t => {
        const pending = TICKET_PRICE - t.amountPaid;
        
        return `
            <tr class="hover:bg-white/5">
                <td class="px-3 py-3 font-mono font-bold">#${t.ticketNumber}</td>
                <td class="px-3 py-3">
                    <div class="font-mono text-sm">
                        ${t.numerosAsignados ? t.numerosAsignados.join(', ') : 'N/A'}
                    </div>
                    <div class="text-xs text-gray-400">
                        Inv: ${t.numerosAsignados ? t.numerosAsignados.map(n => getInvertedNumber(n)).join(', ') : 'N/A'}
                    </div>
                </td>
                <td class="px-3 py-3">
                    <div class="font-semibold">${t.nombre}</div>
                    <div class="text-xs text-gray-400">${t.direccion || 'N/A'}</div>
                </td>
                <td class="px-3 py-3">
                    <div class="text-sm">📧 ${t.correo}</div>
                    <div class="text-sm">📱 ${t.telefono}</div>
                </td>
                <td class="px-3 py-3">
                    <div class="font-bold text-green-400">${t.amountPaid.toLocaleString('es-CO')}</div>
                    <div class="text-xs text-red-400">-${pending.toLocaleString('es-CO')}</div>
                </td>
                <td class="px-3 py-3">
                    <span class="px-2 py-1 rounded text-xs font-bold ${t.estadoPago === 'pagado' ? 'bg-green-600' : 'bg-yellow-600'}">
                        ${t.estadoPago.toUpperCase()}
                    </span>
                </td>
                <td class="px-3 py-3 text-center">
                    ${t.reservationStatus === 'confirmado'  // ✅ CORRECTO (usar 't' no 'ticket')
                        ? '<span class="px-3 py-1 rounded text-xs font-bold bg-green-600">✅ SÍ</span>'
                        : '<span class="px-3 py-1 rounded text-xs font-bold bg-gray-600">❌ NO</span>'
                    }
                </td>
                <td class="px-3 py-3">
                    <div class="flex gap-1 flex-wrap">
                        <button onclick="viewTicketDetails(${t.ticketNumber})" class="bg-blue-600 hover:bg-blue-500 px-2 py-1 rounded text-xs" title="Ver detalles">
                            👁️
                        </button>
                        ${t.reservationStatus !== 'confirmado' ? `
                        <button onclick="confirmReservation(${t.ticketNumber})" class="bg-purple-600 hover:bg-purple-500 px-2 py-1 rounded text-xs font-bold" title="Confirmar reserva">
                            ✅
                        </button>
                        ` : ''}
                        <button onclick="registerManualPaymentFor(${t.ticketNumber})" class="bg-green-600 hover:bg-green-500 px-2 py-1 rounded text-xs" title="Abonar">
                            💰
                        </button>
                        <button onclick="sendEligibilityEmail('${t.correo}', ${t.ticketNumber})" class="bg-indigo-600 hover:bg-indigo-500 px-2 py-1 rounded text-xs" title="Email">
                            📧
                        </button>
                        <button onclick="deleteTicket(${t.ticketNumber})" class="bg-red-600 hover:bg-red-500 px-2 py-1 rounded text-xs" title="Eliminar">
                            🗑️
                        </button>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

/* ============================================
   ✅ CORRECCIÓN 7: Nueva función confirmReservation
============================================ */
async function confirmReservation(ticketNumber) {
    try {
        log('info', 'Confirmando reserva', { ticketNumber });

        const ticketRef = ref(db, `tickets/ticket_${ticketNumber}`);
        const snapshot = await get(ticketRef);

        if (!snapshot.exists()) {
            alert('❌ Boleta no encontrada');
            return;
        }

        const ticket = snapshot.val();

        if (!ticket.numerosAsignados || ticket.numerosAsignados.length === 0) {
            alert('❌ Esta boleta no tiene números asignados');
            return;
        }

        // Si ya está confirmado
        if (ticket.reservationStatus === 'confirmado') {
            alert('✅ Esta reserva ya está confirmada');
            return;
        }

        // Mostrar información del pago
        const metodoPago = ticket.metodoPago || 'No especificado';
        const montoPagado = ticket.amountPaid || 0;
        const pendiente = TICKET_PRICE - montoPagado;

        // Confirmación detallada
        const confirmMsg = `¿Confirmar reserva de la Boleta #${ticketNumber}?
        
        👤 Cliente: ${ticket.nombre}
        🔢 Números: ${ticket.numerosAsignados.join(' y ')}
        💰 Monto registrado: $${montoPagado.toLocaleString('es-CO')}
        💳 Método: ${metodoPago}
        ⏳ Pendiente: $${pendiente.toLocaleString('es-CO')}

        ${metodoPago === 'Efectivo' ? '⚠️ RECUERDA: Verifica que hayas recibido el dinero en efectivo antes de confirmar.' : ''}

        Se enviará correo de confirmación con los números asignados.`;

        if (!confirm(confirmMsg)) {
            return;
        }

        // Actualizar estado
        const now = new Date().toISOString();
        const updates = {
            reservationStatus: 'confirmado',
            reservationConfirmedAt: now
        };

        // Si el monto registrado es el total, marcar como pagado
        if (montoPagado >= TICKET_PRICE) {
            updates.estadoPago = 'pagado';
        }

        await update(ticketRef, updates);

        // Cambiar temporalmente a plantilla de confirmación
        const _originalTemplate = EMAILJS_CONFIG.templateId;
        EMAILJS_CONFIG.templateId = 'template_e76nh7x';
        
        setTimeout(() => {
            EMAILJS_CONFIG.templateId = _originalTemplate;
        }, 10000);

        // Enviar correo de confirmación
        const eligibleWeeks = Object.keys(ticket.eligible || {})
            .filter(w => ticket.eligible[w])
            .join(', ') || 'Ninguna aún';

        const emailSent = await sendEmail({
            to_email: ticket.correo,
            to_name: ticket.nombre,
            ticket_number: ticket.ticketNumber,
            assigned_numbers: `${ticket.numerosAsignados[0]} y ${ticket.numerosAsignados[1]}`,
            inverted1: getInvertedNumber(ticket.numerosAsignados[0]),
            inverted2: getInvertedNumber(ticket.numerosAsignados[1]),
            amount_paid: montoPagado.toLocaleString('es-CO'),
            pending_amount: pendiente.toLocaleString('es-CO'),
            eligible_weeks: eligibleWeeks,
            message_type: 'confirmacion'
        });

        if (emailSent) {
            alert(`✅ Reserva CONFIRMADA
            
            Boleta #${ticketNumber}
            🔢 Números: ${ticket.numerosAsignados.join(' y ')}
            📧 Correo enviado a: ${ticket.correo}`);
            } else {
                alert(`✅ Reserva confirmada pero NO se pudo enviar el correo.
                
            Verifica manualmente: ${ticket.correo}
            Números: ${ticket.numerosAsignados.join(' y ')}`);
            }

            // Refrescar tabla
            if (!document.getElementById('contentDatabase').classList.contains('hidden')) {
                loadDatabaseTable();
            }

            } catch (error) {
                log('error', 'Error al confirmar reserva', error);
                alert('❌ Error al confirmar: ' + (error.message || error));
            }
}

function filterDatabase() {
    const searchTerm = document.getElementById('searchDatabase').value.toLowerCase().trim();
    const statusFilter = document.getElementById('filterStatus').value;
    
    get(ref(db, 'tickets')).then(snapshot => {
        const data = snapshot.val() || {};
        let tickets = Object.values(data);
        
        if (searchTerm) {
            tickets = tickets.filter(t => 
                t.nombre.toLowerCase().includes(searchTerm) ||
                t.correo.toLowerCase().includes(searchTerm) ||
                t.telefono.includes(searchTerm) ||
                (t.direccion && t.direccion.toLowerCase().includes(searchTerm))
            );
        }
        
        if (statusFilter !== 'all') {
            tickets = tickets.filter(t => t.estadoPago === statusFilter);
        }
        
        tickets.sort((a, b) => a.ticketNumber - b.ticketNumber);
        renderDatabaseTable(tickets);
    });
}

function viewTicketDetails(ticketNumber) {
    get(ref(db, `tickets/ticket_${ticketNumber}`)).then(snapshot => {
        if (!snapshot.exists()) return;
        
        const t = snapshot.val();
        const pending = TICKET_PRICE - t.amountPaid;
        const eligibleWeeks = Object.keys(t.eligible || {}).filter(w => t.eligible[w]);
        
        const detailsHTML = `
            <div class="fixed inset-0 bg-black/90 flex items-center justify-center p-4 z-[60]" onclick="this.remove()">
                <div class="bg-gradient-to-br from-purple-900 to-blue-900 rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-2xl font-bold">Boleta #${t.ticketNumber}</h3>
                        <button onclick="this.closest('[onclick]').remove()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-sm">✕</button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-black/30 rounded-lg p-4">
                            <h4 class="font-bold mb-2">🔢 Números Asignados</h4>
                            <p class="text-2xl font-mono font-bold text-yellow-400">${t.numerosAsignados.join(' - ')}</p>
                            <p class="text-sm text-gray-300 mt-1">Invertidos: ${t.numerosAsignados.map(n => getInvertedNumber(n)).join(' - ')}</p>
                        </div>
                        
                        <div class="bg-black/30 rounded-lg p-4">
                            <h4 class="font-bold mb-2">👤 Información Personal</h4>
                            <p><strong>Nombre:</strong> ${t.nombre}</p>
                            <p><strong>Correo:</strong> ${t.correo}</p>
                            <p><strong>Teléfono:</strong> ${t.telefono}</p>
                            <p><strong>Dirección:</strong> ${t.direccion || 'N/A'}</p>
                        </div>
                        
                        <div class="bg-black/30 rounded-lg p-4">
                            <h4 class="font-bold mb-2">💰 Estado de Pago</h4>
                            <div class="flex justify-between mb-2">
                                <span>Pagado:</span>
                                <span class="font-bold text-green-400">${t.amountPaid.toLocaleString('es-CO')}</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span>Pendiente:</span>
                                <span class="font-bold text-red-400">${pending.toLocaleString('es-CO')}</span>
                            </div>
                            <div class="w-full bg-gray-700 rounded-full h-3 mt-2">
                                <div class="bg-green-500 h-3 rounded-full" style="width: ${(t.amountPaid/TICKET_PRICE)*100}%"></div>
                            </div>
                            <p class="text-center text-sm mt-1">${Math.round((t.amountPaid/TICKET_PRICE)*100)}% completado</p>
                            <p class="mt-2"><strong>Método:</strong> ${t.metodoPago}</p>
                            <p><strong>Estado:</strong> <span class="px-2 py-1 rounded text-xs ${t.estadoPago === 'pagado' ? 'bg-green-600' : 'bg-yellow-600'}">${t.estadoPago.toUpperCase()}</span></p>
                        </div>
                        
                        <div class="bg-black/30 rounded-lg p-4">
                            <h4 class="font-bold mb-2">✅ Elegibilidad Semanal</h4>
                            ${eligibleWeeks.length > 0 
                                ? eligibleWeeks.map(w => `<span class="inline-block bg-blue-600 px-3 py-1 rounded mr-2 mb-2">${w}</span>`).join('')
                                : '<span class="text-gray-400">No elegible para ninguna semana aún</span>'
                            }
                        </div>
                        
                        <div class="bg-black/30 rounded-lg p-4">
                            <h4 class="font-bold mb-2">📅 Historial de Pagos</h4>
                            <div class="space-y-2 max-h-40 overflow-y-auto">
                                ${(t.payments || []).map(p => `
                                    <div class="flex justify-between text-sm">
                                        <span>${new Date(p.date).toLocaleString('es-CO')}</span>
                                        <span class="font-bold text-green-400">${p.amount.toLocaleString('es-CO')}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="bg-black/30 rounded-lg p-4">
                            <h4 class="font-bold mb-2">🕐 Fechas</h4>
                            <p class="text-sm"><strong>Reservado:</strong> ${new Date(t.reservedAt).toLocaleString('es-CO')}</p>
                            <p class="text-sm"><strong>Último pago:</strong> ${new Date(t.lastPaymentAt).toLocaleString('es-CO')}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', detailsHTML);
    });
}

function exportToCSV() {
    get(ref(db, 'tickets')).then(snapshot => {
        const data = snapshot.val() || {};
        const tickets = Object.values(data).sort((a, b) => a.ticketNumber - b.ticketNumber);
        
        if (tickets.length === 0) {
            alert('No hay datos para exportar');
            return;
        }
        
        let csv = 'Boleta,Números,Números Invertidos,Nombre,Correo,Teléfono,Dirección,Pagado,Pendiente,Estado,Método Pago,Elegible,Fecha Reserva\n';
        
        tickets.forEach(t => {
            const pending = TICKET_PRICE - t.amountPaid;
            const eligibleWeeks = Object.keys(t.eligible || {}).filter(w => t.eligible[w]).join('; ');
            const nums = t.numerosAsignados ? t.numerosAsignados.join(' - ') : '';
            const invNums = t.numerosAsignados ? t.numerosAsignados.map(n => getInvertedNumber(n)).join(' - ') : '';
            
            csv += `${t.ticketNumber},"${nums}","${invNums}","${t.nombre}","${t.correo}","${t.telefono}","${t.direccion || ''}",${t.amountPaid},${pending},"${t.estadoPago}","${t.metodoPago}","${eligibleWeeks}","${new Date(t.reservedAt).toLocaleString('es-CO')}"\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `boletas_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    });
}

// ============ PAGOS ============
async function loadRecentPayments() {
    const snapshot = await get(ref(db, 'tickets'));
    const data = snapshot.val() || {};
    const tickets = Object.values(data);
    
    const allPayments = [];
    tickets.forEach(t => {
        if (t.payments) {
            t.payments.forEach(p => {
                allPayments.push({
                    ...p,
                    ticketNumber: t.ticketNumber,
                    nombre: t.nombre
                });
            });
        }
    });
    
    allPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const recentDiv = document.getElementById('recentPayments');
    
    if (allPayments.length === 0) {
        recentDiv.innerHTML = '<p class="text-gray-400 text-sm">No hay pagos registrados</p>';
        return;
    }
    
    recentDiv.innerHTML = allPayments.slice(0, 20).map(p => `
        <div class="bg-white/5 rounded p-3 flex justify-between items-center">
            <div>
                <p class="font-bold">Boleta #${p.ticketNumber} - ${p.nombre}</p>
                <p class="text-xs text-gray-400">${new Date(p.date).toLocaleString('es-CO')}</p>
            </div>
            <div class="font-bold text-green-400">
                ${p.amount.toLocaleString('es-CO')}
            </div>
        </div>
    `).join('');
}

async function registerManualPayment() {
    const ticketNum = parseInt(document.getElementById('manualTicketNum').value);
    const amount = parseInt(document.getElementById('manualAmount').value);
    
    if (!ticketNum || !amount || amount < 1000) {
        alert('❌ Ingresa número de boleta y monto válidos');
        return;
    }
    
    await registerPaymentForTicket(ticketNum, amount);
    
    document.getElementById('manualTicketNum').value = '';
    document.getElementById('manualAmount').value = '';
    
    loadRecentPayments();
}

async function registerManualPaymentFor(ticketNumber) {
    const amount = prompt(`Ingresa el monto del abono para la Boleta #${ticketNumber}:`, '5000');
    if (!amount) return;
    
    const parsedAmount = parseInt(amount);
    if (isNaN(parsedAmount) || parsedAmount < 1000) {
        alert('❌ Monto inválido');
        return;
    }
    
    await registerPaymentForTicket(ticketNumber, parsedAmount);
}

async function registerPaymentForTicket(ticketNumber, amount) {
    try {
        log('info', 'Registrando pago', { ticketNumber, amount });
        
        const ticketRef = ref(db, `tickets/ticket_${ticketNumber}`);
        const snapshot = await get(ticketRef);
        
        if (!snapshot.exists()) {
            alert('❌ Boleta no encontrada');
            return;
        }
        
        const ticket = snapshot.val();
        const previousAmount = ticket.amountPaid;
        const newAmount = previousAmount + amount;
        const now = new Date().toISOString();
        
        const newEligibility = calculateEligibility(newAmount, now);
        
        const previouslyEligible = Object.keys(ticket.eligible || {}).filter(w => ticket.eligible[w]);
        const nowEligible = Object.keys(newEligibility).filter(w => newEligibility[w]);
        const newlyEligible = nowEligible.filter(w => !previouslyEligible.includes(w));
        
        const updates = {
            amountPaid: newAmount,
            estadoPago: newAmount >= TICKET_PRICE ? 'pagado' : 'abonado',
            lastPaymentAt: now,
            eligible: newEligibility
        };
        
        const payments = ticket.payments || [];
        payments.push({ amount, date: now });
        updates.payments = payments;
        
        await update(ticketRef, updates);
        
        log('success', 'Pago registrado', { ticketNumber, newAmount });
        alert(`✅ Abono registrado: ${amount.toLocaleString('es-CO')}\nTotal: ${newAmount.toLocaleString('es-CO')}`);
        
        if (newlyEligible.length > 0) {
            await sendEmail({
                to_email: ticket.correo,
                to_name: ticket.nombre,
                ticket_number: ticket.ticketNumber,
                assigned_numbers: `${ticket.numerosAsignados[0]} y ${ticket.numerosAsignados[1]}`,
                amount_paid: newAmount.toLocaleString('es-CO'),
                pending_amount: (TICKET_PRICE - newAmount).toLocaleString('es-CO'),
                eligible_weeks: newlyEligible.join(', '),
                message_type: 'elegibilidad'
            });
        }
        
        if (!document.getElementById('contentDatabase').classList.contains('hidden')) {
            loadDatabaseTable();
        }
        
    } catch (error) {
        log('error', 'Error registrando pago', error);
        alert('❌ Error al registrar pago: ' + error.message);
    }
}

async function findWinner() {
    const number = document.getElementById('winningNumber').value.padStart(3, '0');
    const inverted = getInvertedNumber(number);
    
    log('info', 'Buscando ganador', { number, inverted });
    
    const snapshot = await get(ref(db, 'tickets'));
    const data = snapshot.val() || {};
    const tickets = Object.values(data);
    
    const winners = tickets.filter(t => 
        t.numerosAsignados && (t.numerosAsignados.includes(number) || t.numerosAsignados.includes(inverted))
    );
    
    const resultDiv = document.getElementById('winnerResult');
    
    if (winners.length === 0) {
        resultDiv.innerHTML = `
            <div class="bg-red-600/30 border border-red-500 rounded p-4">
                <p class="font-bold">❌ No se encontró ganador</p>
                <p class="text-sm">Número: ${number} | Invertido: ${inverted}</p>
            </div>
        `;
        return;
    }
    
    log('success', 'Ganador encontrado', { winners: winners.length });
    
    resultDiv.innerHTML = `
        <div class="bg-green-600/30 border border-green-500 rounded p-4">
            <p class="font-bold text-xl mb-3">🎉 ¡Ganador(es) Encontrado(s)!</p>
            <p class="text-sm mb-2">Número: ${number} | Invertido: ${inverted}</p>
            ${winners.map(w => `
                <div class="bg-black/30 rounded p-3 mb-2">
                    <p class="font-bold">Boleta #${w.ticketNumber}</p>
                    <p class="text-sm">🔢 Números: ${w.numerosAsignados[0]} y ${w.numerosAsignados[1]}</p>
                    <p class="text-sm">👤 ${w.nombre}</p>
                    <p class="text-sm">📧 ${w.correo}</p>
                    <p class="text-sm">📱 ${w.telefono}</p>
                    <p class="text-sm">📍 ${w.direccion}</p>
                    <p class="text-sm font-bold ${w.estadoPago === 'pagado' ? 'text-green-400' : 'text-yellow-400'}">
                        💰 ${w.estadoPago === 'pagado' ? 'PAGADO COMPLETO' : `Abonado ${w.amountPaid.toLocaleString('es-CO')}`}
                    </p>
                </div>
            `).join('')}
        </div>
    `;
}

async function sendEligibilityEmail(email, ticketNumber) {
    const snapshot = await get(ref(db, `tickets/ticket_${ticketNumber}`));
    if (!snapshot.exists()) return;
    
    const ticket = snapshot.val();
    const eligibleWeeks = Object.keys(ticket.eligible || {}).filter(w => ticket.eligible[w]);
    
    await sendEmail({
        to_email: email,
        to_name: ticket.nombre,
        ticket_number: ticket.ticketNumber,
        assigned_numbers: `${ticket.numerosAsignados[0]} y ${ticket.numerosAsignados[1]}`,
        inverted1: getInvertedNumber(ticket.numerosAsignados[0]),
        inverted2: getInvertedNumber(ticket.numerosAsignados[1]),
        amount_paid: ticket.amountPaid.toLocaleString('es-CO'),
        pending_amount: (TICKET_PRICE - ticket.amountPaid).toLocaleString('es-CO'),
        eligible_weeks: eligibleWeeks.join(', ') || 'Ninguna',
        message_type: 'recordatorio'
    });
    
    alert('✅ Correo enviado');
}

async function deleteTicket(ticketNumber) {
    if (!confirm(`¿Eliminar la Boleta #${ticketNumber}?`)) return;
    
    try {
        const ticketRef = ref(db, `tickets/ticket_${ticketNumber}`);
        const snapshot = await get(ticketRef);
        
        if (snapshot.exists()) {
            const ticket = snapshot.val();
            if (ticket.numerosAsignados) {
                ticket.numerosAsignados.forEach(num => {
                    if (!availableNumbers.includes(num)) {
                        availableNumbers.push(num);
                    }
                });
            }
            
            await set(ticketRef, null);
            log('success', 'Boleta eliminada', { ticketNumber });
            alert('✅ Boleta eliminada');
            loadDatabaseTable();
        }
    } catch (error) {
        log('error', 'Error eliminando boleta', error);
        alert('❌ Error: ' + error.message);
    }
}


async function loadAllTickets() {
    await loadDatabaseTable();
}

/* ============================================
   FUNCIONES GLOBALES - MODAL TÉRMINOS
============================================ */
function showTerms() {
    document.getElementById('termsModal').classList.remove('hidden');
}

function closeTerms() {
    document.getElementById('termsModal').classList.add('hidden');
}

/* ============================================
   EXPONER FUNCIONES AL SCOPE GLOBAL
============================================ */
window.openPurchaseForm = openPurchaseForm;
window.closePurchaseForm = closePurchaseForm;
window.submitPurchase = submitPurchase;
window.showTerms = showTerms;
window.closeTerms = closeTerms;
window.openWhatsAppManual = openWhatsAppManual;
window.checkAdminAccess = checkAdminAccess;
window.toggleAdmin = toggleAdmin;
window.loginAdmin = loginAdmin;
window.switchAdminTab = switchAdminTab;
window.loadNumbersManagement = loadNumbersManagement;
window.searchSpecificNumber = searchSpecificNumber;
window.showAllNumbers = showAllNumbers;
window.loadDatabaseTable = loadDatabaseTable;
window.filterDatabase = filterDatabase;
window.viewTicketDetails = viewTicketDetails;
window.exportToCSV = exportToCSV;
window.loadRecentPayments = loadRecentPayments;
window.loadAllTickets = loadAllTickets;
window.registerManualPayment = registerManualPayment;
window.registerManualPaymentFor = registerManualPaymentFor;
window.findWinner = findWinner;
window.sendEligibilityEmail = sendEligibilityEmail;
window.deleteTicket = deleteTicket;
window.confirmReservation = confirmReservation;

// Iniciar
checkAdminAccess();

</script>
<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
